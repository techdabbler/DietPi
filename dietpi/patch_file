#!/bin/bash
{
	#////////////////////////////////////
	# DietPi Patch File Script
	#
	#////////////////////////////////////
	# Created by Daniel Knight / daniel.knight@dietpi.com / dietpi.com
	#
	#////////////////////////////////////
	#
	# Info:
	# - Online patching for hosts filesystem.
	# - Runs from dietpi-update
	#
	# Usage:
	# - /DietPi/dietpi/patch_file iCurrentVersion iServerVersion
	#////////////////////////////////////

	#Force en_GB Locale for whole script. Prevents incorrect parsing with non-english locales.
	LANG=en_GB.UTF-8

	#Ensure we are in users home dir: https://github.com/Fourdee/DietPi/issues/905#issuecomment-298223705
	cd "$HOME"

	#/////////////////////////////////////////////////////////////////////////////////////
	#Globals
	#/////////////////////////////////////////////////////////////////////////////////////
	VERSION_CURRENT=$1
	VERSION_SERVER=$2

	HW_MODEL=$(sed -n 1p /DietPi/dietpi/.hw_model)
	HW_MODEL_DESCRIPTION=$(sed -n 2p /DietPi/dietpi/.hw_model)
	DISTRO=$(sed -n 3p /DietPi/dietpi/.hw_model)
	HW_ARCH=$(sed -n 6p /DietPi/dietpi/.hw_model)

	AUTOINSTALL_ENABLED=$(cat /DietPi/dietpi.txt | grep -m1 '^AUTO_Install_Enable=' | sed 's/.*=//')
	USER_INPUTS=1
	if (( $AUTOINSTALL_ENABLED == 1 && $(cat /DietPi/dietpi/.install_stage) <= 0 )); then #Automated

		USER_INPUTS=0

	fi

	#Apt-get upgrade, noninteractive func
	AGU(){

		DEBIAN_FRONTEND='noninteractive' apt-get upgrade -y

	}

	AGDU(){

		DEBIAN_FRONTEND='noninteractive' apt-get dist-upgrade -y

	}

	FP_EMR='/DietPi/dietpi/.patch_emr'
	EMR_INDEX=0

	Obtain_EMR_Index(){

		if [ ! -f "$FP_EMR" ]; then

			echo 0 > "$FP_EMR"

		else

			EMR_INDEX=$(cat "$FP_EMR")

		fi

	}

	Update_EMR_Index(){

		((EMR_INDEX++))
		echo $EMR_INDEX > "$FP_EMR"

	}

	#/////////////////////////////////////////////////////////////////////////////////////
	# Main
	#/////////////////////////////////////////////////////////////////////////////////////
	#Always update HW_* indexs
	/DietPi/dietpi/dietpi-obtain_hw_model

	#/////////////////////////////////////////////////////////////////////////////////////
	#Emergency Patch System:
	#	This runs before all standard incremental patches. Useful for when shi* hits the ...

	Obtain_EMR_Index

	# - https://github.com/Fourdee/DietPi/issues/669
	#	deb security repo now has a forced https redirect, which requires apt-transport-https to be installed, but is only installable from deb security repo........
	if (( $EMR_INDEX == 0 )); then

		if (( ! $(dpkg --get-selections | grep -ci -m1 '^apt-transport-https') )); then

			apt-get install -y apt-transport-https
			if (( $? != 0 )); then

				# - armv7
				if (( $HW_ARCH == 2 )); then

					INSTALL_URL='http://security.debian.org/debian-security/pool/updates/main/c/curl/libcurl3-gnutls_7.38.0-4+deb8u5_armhf.deb'

				# - arm64
				elif (( $HW_ARCH == 3 )); then

					INSTALL_URL='http://security.debian.org/debian-security/pool/updates/main/c/curl/libcurl3-gnutls_7.38.0-4+deb8u5_arm64.deb'

				# - x86_64
				elif (( $HW_ARCH == 10 )); then

					INSTALL_URL='http://security.debian.org/debian-security/pool/updates/main/c/curl/libcurl3-gnutls_7.38.0-4+deb8u5_amd64.deb'

				fi

				wget "$INSTALL_URL" -O package.deb
				dpkg -i package.deb
				rm package.deb

				# - armv7
				if (( $HW_ARCH == 2 )); then

					INSTALL_URL='http://security.debian.org/debian-security/pool/updates/main/a/apt/libapt-pkg4.12_1.0.9.8.4_armhf.deb'

				# - arm64
				elif (( $HW_ARCH == 3 )); then

					INSTALL_URL='http://security.debian.org/debian-security/pool/updates/main/a/apt/libapt-pkg4.12_1.0.9.8.4_arm64.deb'

				# - x86_64
				elif (( $HW_ARCH == 10 )); then

					INSTALL_URL='http://security.debian.org/debian-security/pool/updates/main/a/apt/libapt-pkg4.12_1.0.9.8.4_amd64.deb'

				fi

				wget "$INSTALL_URL" -O package.deb
				dpkg -i package.deb
				rm package.deb

				# - armv7
				if (( $HW_ARCH == 2 )); then

					INSTALL_URL='http://security.debian.org/debian-security/pool/updates/main/a/apt/apt-transport-https_1.0.9.8.4_armhf.deb'

				# - arm64
				elif (( $HW_ARCH == 3 )); then

					INSTALL_URL='http://security.debian.org/debian-security/pool/updates/main/a/apt/apt-transport-https_1.0.9.8.4_arm64.deb'

				# - x86_64
				elif (( $HW_ARCH == 10 )); then

					INSTALL_URL='http://security.debian.org/debian-security/pool/updates/main/a/apt/apt-transport-https_1.0.9.8.4_amd64.deb'

				fi

				wget "$INSTALL_URL" -O package.deb
				dpkg -i package.deb
				rm package.deb

			fi

		fi

		Update_EMR_Index

	fi

	#Debian apt mirror fix: https://github.com/Fourdee/DietPi/issues/755
	if (( $EMR_INDEX == 1 )); then

		#-------------------------------------------------------------------------------
		sed -i "s@debian.org/debian[[:space:]]@debian.org/debian/ @g" /etc/apt/sources.list
		#-------------------------------------------------------------------------------
		Update_EMR_Index

	fi

	#Placeholder
	# if (( $EMR_INDEX == 2 )); then

		# Update_EMR_Index

	# fi

	#/////////////////////////////////////////////////////////////////////////////////////
	#Incremental patch system:

	if (( $VERSION_CURRENT == 102 )); then
		#-------------------------------------------------------------------------------
		#DNS fixes for STATIC. We MUST supply DNS servers if using STATIC, else /etc/resolv.conf will be empty.
		# - Update curret network details
		/DietPi/dietpi/func/obtain_network_details
		# - Add missing disabled dns-nameservers to wlan.
		sed -i "/wpa-psk /a #dns-nameservers 8.8.8.8 8.8.4.4" /etc/network/interfaces
		# - If static IP is currently in use, enable google dns-nameservers.
		active_network_adapter=$(sed -n 3p /DietPi/dietpi/.network)
		if (( $( cat /etc/network/interfaces | grep -ci -m1 "iface $active_network_adapter inet static") == 1 )); then
			sed -i 's/^#dns-nameservers/dns-nameservers/g' /etc/network/interfaces
		fi
		# - Delete 'Uncomment for Google DNS servers reference'
		sed -i '/Uncomment for Google/d' /etc/network/interfaces
		# - Add DNS entry to dietpi.txt
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'Static_DNS=') == 0 )); then
			sed -i "/Static_Gateway=/a Static_DNS=8.8.8.8" /DietPi/dietpi.txt
		fi
		#-------------------------------------------------------------------------------
		#Missing Resolvconf
		/DietPi/dietpi/dietpi-apt-get_update 1
		apt-get install resolvconf -y
		#-------------------------------------------------------------------------------
		#New Bash Alias's
		if (( $(cat /etc/bash.bashrc | grep -ci -m1 'dietpi-autostart=') == 0 )); then
			sed -i "/#DietPi Additions/a alias dietpi-autostart='/DietPi/dietpi/dietpi-autostart'" /etc/bash.bashrc
		fi

		if (( $(cat /etc/bash.bashrc | grep -ci -m1 'dietpi-affinity=') == 0 )); then
			sed -i "/#DietPi Additions/a alias dietpi-affinity='/DietPi/dietpi/dietpi-affinity'" /etc/bash.bashrc
		fi

		if (( $(cat /etc/bash.bashrc | grep -ci -m1 'dietpi-letsencrypt=') == 0 )); then
			sed -i "/#DietPi Additions/a alias dietpi-letsencrypt='/DietPi/dietpi/dietpi-letsencrypt'" /etc/bash.bashrc
		fi
		# - DietPi-Cloudshell input cli changes
		if (( $(cat /etc/bash.bashrc | grep -ci -m1 'dietpi-cloudshell=') == 1 )); then
			sed -i '/alias dietpi-cloudshell=/d' /etc/bash.bashrc &> /dev/null
			sed -i "/#DietPi Additions/a alias dietpi-cloudshell='/DietPi/dietpi/dietpi-cloudshell'" /etc/bash.bashrc
		fi
		#-------------------------------------------------------------------------------
		#NTPD drift file ownership must match user that NTPD runs as, or it wont write to drift file (even though its ran as root.......)
		chown root:root /var/lib/ntp/ntp.drift
		#-------------------------------------------------------------------------------
		#Information change for crontab (DietPi-Cron instead of dietpi-config)
		sed -i '/#Please use dietpi-config/c\#Please use DietPi-Cron to change cron start times' /etc/crontab &> /dev/null
		#-------------------------------------------------------------------------------
		#Proftpd patch | to stop logging wtmp /var/log/wtmp: No such file or directory -Gordon Williams change
		if [ -f /etc/proftpd/proftpd.conf ]; then
			if (( $(cat /etc/proftpd/proftpd.conf | grep -ci -m1 'WtmpLog') == 0 )); then
				sed -i "/SystemLog /a #to stop logging wtmp /var/log/wtmp: No such file or directory -Gordon Williams change\nWtmpLog off" /etc/proftpd/proftpd.conf
			fi
		fi
		#-------------------------------------------------------------------------------


	elif (( $VERSION_CURRENT == 103 )); then
		#-------------------------------------------------------------------------------
		# New automation/misc options > dietpi.txt
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 '^AUTO_AutoLogin=') == 0 )); then
			sed -i "/# >> Automation Options/a #Automatically logs the root user in to start 1st run setup.\nAUTO_AutoLogin=0" /DietPi/dietpi.txt
		fi
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 '^Hostname=') == 0 )); then
			sed -i "/# >> Automation Options/a Hostname=DietPi" /DietPi/dietpi.txt
		fi
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 '^Swapfile_Size=') == 0 )); then
			sed -i "/# >> Automation Options/a Swapfile_Size=100" /DietPi/dietpi.txt
		fi
		#-------------------------------------------------------------------------------
		#FP name change for autoboot (now DietPi-Autostart)
		mv /DietPi/dietpi/.auto_boot_index /DietPi/dietpi/.dietpi-autostart_index
		#-------------------------------------------------------------------------------
		#DietPi-Cloudshell - 'c / 'f option / Target output
		if [ -f /DietPi/dietpi/.dietpi-cloudshell ]; then
			sed -i '4s/.*/1/' /DietPi/dietpi/.dietpi-cloudshell
			sed -i '5s/.*/0/' /DietPi/dietpi/.dietpi-cloudshell
		fi
		#-------------------------------------------------------------------------------
		#dphys-swapfile - add location to conf
		if (( $(cat /etc/dphys-swapfile | grep -ci -m1 '^CONF_SWAPFILE=') == 0 )); then
			echo -e "CONF_SWAPFILE=/var/swap" >> /etc/dphys-swapfile
		fi
		#-------------------------------------------------------------------------------
		#PiHole Update
		if [ -f /usr/local/bin/gravity.sh ]; then
			#remove old lists (we need to regenerate)
			rm /etc/pihole/list.*
			rm /etc/pihole/pihole.*
			rm /etc/pihole/gravity.list

			cp /DietPi/dietpi/conf/pihole_gravity /usr/local/bin/gravity.sh
			chmod +x /usr/local/bin/gravity.sh
			/usr/local/bin/gravity.sh
		fi
		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 104 )); then
		#-------------------------------------------------------------------------------
		#DietPi-Software additions
		# - automation add option
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'AUTO_DietpiSoftware_Install_WIFIHOTSPOT=') == 0 )); then
			sed -i "/AUTO_DietpiSoftware_Install_WEBSERVER_MYADMINPHP=/a AUTO_DietpiSoftware_Install_WIFIHOTSPOT=0" /DietPi/dietpi.txt
		fi

		#-------------------------------------------------------------------------------
		#dietpi-cleaner alias missing from bashrc
		if (( $(cat /etc/bash.bashrc | grep -ci -m1 'dietpi-cleaner=') == 0 )); then
			sed -i "/#DietPi Additions/a alias dietpi-cleaner='/DietPi/dietpi/dietpi-cleaner'" /etc/bash.bashrc
		fi
		#-------------------------------------------------------------------------------
		#Wifi Hotspot settings
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'wifi_hotspot_ssid=') == 0 )); then
			sed -i "/ntpd_update_mode=/a\ \n#Wifi Hotspot\nwifi_hotspot_ssid=DietPi-HotSpot\n# - minimum of 8 characters\nwifi_hotspot_key=dietpihotspot\nwifi_hotspot_channel=3" /DietPi/dietpi.txt
		fi
		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 105 )); then
		#-------------------------------------------------------------------------------
		#DietPi-Software additions
		# - automation add option
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'AUTO_DietpiSoftware_Install_SHAIRPORTSYNC=') == 0 )); then
			sed -i "/AUTO_DietpiSoftware_Install_WEBSERVER_MYADMINPHP=/a AUTO_DietpiSoftware_Install_SHAIRPORTSYNC=0" /DietPi/dietpi.txt
		fi
		#-------------------------------------------------------------------------------
		#dbus-x11 now installed by default with xserver installations. Required for ibus, fcitx etc. inputs.
		if [ -f /DietPi/dietpi/.installed ]; then
			if (( $(cat /DietPi/dietpi/.installed | grep -ci -m1 'XSERVERXORG 2') == 1 )); then
				/DietPi/dietpi/dietpi-apt-get_update 1
				apt-get install dbus-x11 -y
			fi
		fi
		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 106 )); then
		#-------------------------------------------------------------------------------
		# DietPi-Process Tool
		# -  bash alias add dietpi-process_control
		if (( $(cat /etc/bash.bashrc | grep -ci -m1 'dietpi-process_tool=') == 0 )); then
			sed -i "/#DietPi Additions/a alias dietpi-process_tool='/DietPi/dietpi/dietpi-process_tool'" /etc/bash.bashrc
		fi
		# - bash alias, remove nice/affinity
		sed -i '/dietpi-nice/d' /etc/bash.bashrc
		sed -i '/dietpi-affinity/d' /etc/bash.bashrc
		#remove .dietpi-nice .dietpi-affinity settings
		rm /DietPi/dietpi/.dietpi-nice
		rm /DietPi/dietpi/.dietpi-affinity
		#-------------------------------------------------------------------------------
		#Prompt user regarding nice/affinity changes
		if [ -f /DietPi/dietpi/.installed ]; then
			whiptail --title "Info: DietPi-Process_Tool" --msgbox "DietPi-Affinity and DietPi-Nice has now been replaced by DietPi-Process_Tool.\n\nIf you have used these programs in the past, you will need to reapply your nice and affinity settings by running the following command, after you reboot the system.\n\ndietpi-process_tool" 14 70
		fi
		#-------------------------------------------------------------------------------
		#Enable IPv6 for all DietPi images by default
		rm /etc/modprobe.d/blacklist-ipv6.conf &> /dev/null
		#Update /etc/hosts with ipv6
		if (( $(cat /etc/hosts | grep -ci -m1 'ip6-localhost') == 0 )); then
			cat << _EOF_ >> /etc/hosts
::1             localhost ip6-localhost ip6-loopback
ff02::1         ip6-allnodes
ff02::2         ip6-allrouters
_EOF_
		fi
		#-------------------------------------------------------------------------------
		#DietPi-Software additions
		# - automation add option
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'AUTO_DietpiSoftware_Install_BRUTEFIR=') == 0 )); then
			sed -i "/AUTO_DietpiSoftware_Install_WEBSERVER_MYADMINPHP=/a AUTO_DietpiSoftware_Install_BRUTEFIR=0" /DietPi/dietpi.txt
		fi
		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 107 )); then
		#-------------------------------------------------------------------------------
		#DietPi-Software additions
		# - automation add option
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'AUTO_DietpiSoftware_Install_PYDIO=') == 0 )); then
			sed -i "/AUTO_DietpiSoftware_Install_WEBSERVER_MYADMINPHP=/a AUTO_DietpiSoftware_Install_PYDIO=0" /DietPi/dietpi.txt
		fi
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'AUTO_DietpiSoftware_Install_SQUEEZELITE=') == 0 )); then
			sed -i "/AUTO_DietpiSoftware_Install_WEBSERVER_MYADMINPHP=/a AUTO_DietpiSoftware_Install_SQUEEZELITE=0" /DietPi/dietpi.txt
		fi
		#-------------------------------------------------------------------------------
		#DESKTOP_LXDE dietpi-nice > dietpi-process_tool
		if [ -f /DietPi/dietpi/.installed ]; then
			if (( $(cat /DietPi/dietpi/.installed | grep -ci -m1 'DESKTOP_LXDE 2') == 1 )); then
				rm /usr/share/applications/dietpi-nice.desktop
				ln -sf /DietPi/dietpi/conf/desktop/dietpi-process_tool.desktop /usr/share/applications/dietpi-process_tool.desktop
			fi
		fi
		#-------------------------------------------------------------------------------
	elif (( $VERSION_CURRENT == 108 )); then
		#-------------------------------------------------------------------------------
		#Pydrio: Impossible write into the AJXP_DATA_PATH folder https://github.com/Fourdee/DietPi/issues/186
		chown -R www-data:www-data /pydio_data &> /dev/null
		chown -R www-data:www-data /mnt/usb_1/pydio_data &> /dev/null
		#-------------------------------------------------------------------------------
		#PiHole webstats patch https://github.com/Fourdee/DietPi/issues/187#issue-131328814
		if [ -f /usr/local/bin/gravity.sh ]; then
			wget https://raw.githubusercontent.com/pi-hole/pi-hole/master/advanced/Scripts/chronometer.sh -O /usr/local/bin/chronometer.sh
			chmod +x /usr/local/bin/chronometer.sh

			/DietPi/dietpi/dietpi-apt-get_update 1
			apt-get install -y bc
		fi
		#-------------------------------------------------------------------------------
		#DietPi-Software additions
		# - Lighttpd
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'AUTO_DietpiSoftware_Install_WEBSERVER_LLMP=') == 0 )); then
			sed -i "/AUTO_DietpiSoftware_Install_WEBSERVER_MYADMINPHP=/a AUTO_DietpiSoftware_Install_WEBSERVER_LLMP=0" /DietPi/dietpi.txt
		fi
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'AUTO_DietpiSoftware_Install_WEBSERVER_LLSP=') == 0 )); then
			sed -i "/AUTO_DietpiSoftware_Install_WEBSERVER_MYADMINPHP=/a AUTO_DietpiSoftware_Install_WEBSERVER_LLSP=0" /DietPi/dietpi.txt
		fi

		# - MariaDB
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'AUTO_DietpiSoftware_Install_WEBSERVER_LAAP=') == 0 )); then
			sed -i "/AUTO_DietpiSoftware_Install_WEBSERVER_MYADMINPHP=/a AUTO_DietpiSoftware_Install_WEBSERVER_LAAP=0" /DietPi/dietpi.txt
		fi
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'AUTO_DietpiSoftware_Install_WEBSERVER_LEAP=') == 0 )); then
			sed -i "/AUTO_DietpiSoftware_Install_WEBSERVER_MYADMINPHP=/a AUTO_DietpiSoftware_Install_WEBSERVER_LEAP=0" /DietPi/dietpi.txt
		fi
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'AUTO_DietpiSoftware_Install_WEBSERVER_LLAP=') == 0 )); then
			sed -i "/AUTO_DietpiSoftware_Install_WEBSERVER_MYADMINPHP=/a AUTO_DietpiSoftware_Install_WEBSERVER_LLAP=0" /DietPi/dietpi.txt
		fi

		#-------------------------------------------------------------------------------
		#Disable powersaving for 8188eu wifi chipsets
		echo -e "options 8188eu rtw_power_mgnt=0" > /etc/modprobe.d/8188eu.conf
		#-------------------------------------------------------------------------------
		#debconf-get-selections mising from odroid's
		/DietPi/dietpi/dietpi-apt-get_update 1
		apt-get install -y debconf-utils
		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 109 )); then
		#-------------------------------------------------------------------------------
		#Put XU4 kernel updates on hold to prevent automated installations causing broken kernel/modules.
		#https://github.com/Fourdee/DietPi/issues/185#issuecomment-183343474
		if (( $HW_MODEL == 11 )); then
			apt-mark hold linux-headers-armhf-odroid-xu3 linux-image-armhf-odroid-xu3
		fi
		#-------------------------------------------------------------------------------
		#LXDE desktop, remove dietpi-nice.desktop links, add dietpi-process_tool
		if [ -f /DietPi/dietpi/.installed ]; then
			if (( $(cat /DietPi/dietpi/.installed | grep -ci -m1 'DESKTOP_LXDE 2') == 1 )); then
				rm /usr/share/applications/dietpi-nice.desktop
				ln -sf /DietPi/dietpi/conf/desktop/dietpi-process_tool.desktop /usr/share/applications/dietpi-process_tool.desktop
			fi
		fi
		#-------------------------------------------------------------------------------
		#DietPi.txt | new option to override user/personal data target directory in DietPi-Software: https://github.com/Fourdee/DietPi/issues/198
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'dietpi_userdata_basedirectory=') == 0 )); then
			sed -i "/wifi_hotspot_channel=/a #------------------------------------------------------------------------------------------------------\n# D I E T - P I\n# DietPi-Software settings.\n#------------------------------------------------------------------------------------------------------\n#Override target directory for user/personal data.\n#This is applied to software configurations when installing software (eg: owncloud, bittorrent downloads etc).\n#  Auto = Automatic (default). If USB dedicated drive was setup /mnt/usb_1, else, /root\n#  /mnt/Where/I/Want/My/Data = Example\n#  /mnt/user_data = Example\ndietpi_userdata_basedirectory=Auto\n" /DietPi/dietpi.txt
		fi
		#-------------------------------------------------------------------------------
		#Updated network details script , rerun
		/DietPi/dietpi/func/obtain_network_details
		#-------------------------------------------------------------------------------
		#BC is now installed by default on all DietPi systems. bc is needed for bash floating point calculations that many scripts rely on.
		/DietPi/dietpi/dietpi-apt-get_update 1
		apt-get install -y bc
		#-------------------------------------------------------------------------------
		#Cloudshell new option | NETWORK_USAGE_CURRENT_OUTPUT_TYPE
		if [ -f /DietPi/dietpi/.dietpi-cloudshell ]; then
			sed -i '6s/.*/0/' /DietPi/dietpi/.dietpi-cloudshell
		fi
		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 110 )); then
		#-------------------------------------------------------------------------------
		#DietPi-Software additions:
		# - Oracle Java 8 jdk
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'AUTO_DietpiSoftware_Install_ORACLEJAVA=') == 0 )); then
			sed -i "/AUTO_DietpiSoftware_Install_FFMPEG=/a AUTO_DietpiSoftware_Install_ORACLEJAVA=0" /DietPi/dietpi.txt
		fi
		#-------------------------------------------------------------------------------
		#RPI Jessie:
		# - remove /etc/apt/sources.list.d/collabora.list. This was left over from Wheezy dist-upgrade and is not required.
		# - Update /etc/apt/sources.list.d/raspi.list to match Raspbian Jessie raspi.list.
		if (( $HW_MODEL < 10 )) && (( $DISTRO == 3 )); then
			rm /etc/apt/sources.list.d/collabora.list
			cat << _EOF_ > /etc/apt/sources.list.d/raspi.list
deb http://archive.raspberrypi.org/debian/ jessie main ui
# Uncomment line below then 'apt-get update' to enable 'apt-get source'
#deb-src http://archive.raspberrypi.org/debian/ jessie main ui
_EOF_
			/DietPi/dietpi/dietpi-apt-get_update 2
		fi
		#-------------------------------------------------------------------------------
		#RPI - snd-bcm2835 is now disabled by default.
		if (( $HW_MODEL < 10 )) && (( $(dpkg -l | grep -ci -m1 'alsa') == 0 )); then
			/DietPi/dietpi/func/dietpi-set_hardware soundcard none
		fi
		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 111 )); then
		#-------------------------------------------------------------------------------
		#RPi 3 - WiFi hotspot. Internal Wifi fix.
		# - Disable driver definition
		# - Use non-modified hostapd binary from Jessie repo.
		if (( $HW_MODEL == 3 )) && (( $(dpkg -l | grep -ci -m1 'hostapd') == 1 )); then
			apt-get remove hostapd -y
			apt-get install hostapd -y
			sed -i '/driver=/c\#driver=rtl871xdrv/' /etc/hostapd/hostapd.conf
		fi
		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 112 )); then
		#-------------------------------------------------------------------------------
		#/DietPi/dietpi/dietpi-apt-get_update 1 is now called in dietpi-update, before this patch file is launched.
		# - Run it now for previous DietPi versions. As dietpi-update is loaded into memory, it wont be updated until a reboot.
		/DietPi/dietpi/dietpi-apt-get_update 1
		#-------------------------------------------------------------------------------
		#New location for dietpi-software installed "non-service" based control scripts
		mkdir -p /etc/dietpi/dietpi-software/services

		# - move to new location, if installed
		mv /etc/deluge_init /etc/dietpi/dietpi-software/services/deluge.service &> /dev/null
		mv /etc/raspimjpeg_init /etc/dietpi/dietpi-software/services/raspimjpeg.service &> /dev/null
		mv /etc/squeezeboxserver_init /etc/dietpi/dietpi-software/services/squeezeboxserver.service &> /dev/null
		mv /etc/BruteFIR/brutefir.service /etc/dietpi/dietpi-software/services/brutefir.service &> /dev/null
		chmod -R +x /etc/dietpi/dietpi-software/services
		#-------------------------------------------------------------------------------
		#DietPi-Software additions:
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'AUTO_DietpiSoftware_Install_WEBSERVER_REDIS=') == 0 )); then
			sed -i "/AUTO_DietpiSoftware_Install_WEBSERVER_MYADMINPHP=/a AUTO_DietpiSoftware_Install_WEBSERVER_REDIS=0" /DietPi/dietpi.txt
		fi
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'AUTO_DietpiSoftware_Install_EMONHUB=') == 0 )); then
			sed -i "/AUTO_DietpiSoftware_Install_SQUEEZELITE=/a AUTO_DietpiSoftware_Install_EMONHUB=0" /DietPi/dietpi.txt
		fi
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'AUTO_DietpiSoftware_Install_EMONCMS=') == 0 )); then
			sed -i "/AUTO_DietpiSoftware_Install_SQUEEZELITE=/a AUTO_DietpiSoftware_Install_EMONCMS=0" /DietPi/dietpi.txt
		fi
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'AUTO_DietpiSoftware_Install_NODEJS=') == 0 )); then
			sed -i "/AUTO_DietpiSoftware_Install_BUILDESSENTIAL=/a AUTO_DietpiSoftware_Install_NODEJS=0" /DietPi/dietpi.txt
		fi
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'AUTO_DietpiSoftware_Install_RPIMONITOR=') == 0 )); then
			sed -i "/AUTO_DietpiSoftware_Install_SQUEEZELITE=/a AUTO_DietpiSoftware_Install_RPIMONITOR=0" /DietPi/dietpi.txt
		fi
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'AUTO_DietpiSoftware_Install_BAIKAL=') == 0 )); then
			sed -i "/AUTO_DietpiSoftware_Install_SQUEEZELITE=/a AUTO_DietpiSoftware_Install_BAIKAL=0" /DietPi/dietpi.txt
		fi
		#-------------------------------------------------------------------------------
		#PiHole webstats update
		if [ -f /var/www/pihole/index.php ]; then
			cd ~/
			rm -R /var/www/pihole/*
			wget https://github.com/Fourdee/AdminLTE/archive/master.zip -O package.zip
			unzip package.zip
			rm package.zip
			mv AdminLTE*/* /var/www/pihole/
			rm -R AdminLTE*
		fi
		#-------------------------------------------------------------------------------
		#RPi Jessie DietPi v111 image missing ipv6 in hosts. Add if it doesnt exist
		if (( $(cat /etc/hosts | grep -ci -m1 'ip6-localhost') == 0 )); then
			cat << _EOF_ >> /etc/hosts
::1				localhost ip6-localhost ip6-loopback
ff02::1         ip6-allnodes
ff02::2         ip6-allrouters
_EOF_
		fi
		#-------------------------------------------------------------------------------
		#Odroid C2 - Kodi sound fix
		if (( $HW_MODEL == 12 )); then
			if (( $(dpkg -l | grep -ci -m1 'kodi-odroid') == 1 )); then

				# - upgrade kodi
				apt-get update
				AGU

				# - Remove pulse audio workaround fix we used.
				apt-get purge pulseaudio -y
				apt-get autoremove --purge -y

				# - Asound.conf by Oversun.
				cat << _EOF_ > /etc/asound.conf
pcm.!default {
	type plug
	slave {
		pcm "hw:0,0"
		format S32_LE
	}
}
_EOF_
			fi
		fi
		#-------------------------------------------------------------------------------
		#fbset now installed by default
		apt-get install -y fbset
		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 113 )); then
		#-------------------------------------------------------------------------------
		#DietPi-Software Additions
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'AUTO_DietpiSoftware_Install_TORHOTSPOT=') == 0 )); then
			sed -i "/AUTO_DietpiSoftware_Install_WIFIHOTSPOT=/a AUTO_DietpiSoftware_Install_TORHOTSPOT=0" /DietPi/dietpi.txt
		fi
		#-------------------------------------------------------------------------------
		# New dietpi-software options > dietpi.txt
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 '^dietpi_emonhub_apikey=') == 0 )); then
			sed -i "/dietpi_userdata_basedirectory=/a #Enter your EmonCMS.org write API key here. It will be applied automatically during EmonPi/Hub installation.\n# - eg: dietpi_emonhub_apikey=b4dfmk2o203mmxx93a\ndietpi_emonhub_apikey=" /DietPi/dietpi.txt
		fi
		#-------------------------------------------------------------------------------
		#C1 - Ondemand does not work, replace with interactive: https://github.com/Fourdee/DietPi/issues/248
		if (( $HW_MODEL == 10 )) && (( $(cat /DietPi/dietpi.txt | grep -ci -m1 '^cpu_governor=ondemand') == 1 )); then
			sed -i "/cpu_governor=/c\cpu_governor=interactive" /DietPi/dietpi.txt
			/DietPi/dietpi/dietpi-cpu_set
		fi
		#-------------------------------------------------------------------------------
		#RPi | Enable max usb current by default
		sed -i '/max_usb_current=/c\max_usb_current=1' /DietPi/config.txt
		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 114 )); then
		#-------------------------------------------------------------------------------
		#OPi PC -  Comminuty Fix vcore/freq: https://github.com/Fourdee/DietPi/issues/263
		if (( $HW_MODEL == 30 )); then

			# - Warn user of OPi-PC only support after this is run.
			whiptail --title "OPi-PC vcore/stability fix" --yesno "This will apply the community vcore/stability fix on your system. The fix resolves known issues with the H3 clockspeeds and vcore voltages. Whilst this patch has been tested on OPi-PC systems, there is no guarantee the fix will work, and, could render your system unbootable.\n\nNB: If you NOT using an OPi-PC, say no.\n\nDo you wish to apply the community H3 patch?" --backtitle "DietPi-Update" --defaultno 16 70
			CHOICE=$?
			if (( $CHOICE == 0 )); then
				wget http://dietpi.com/downloads/misc/community/h3_fix_vcore_clock.sh -O patch
				chmod +x patch
				./patch
				rm patch
			fi

		fi
		#-------------------------------------------------------------------------------
		#Webserver preference system
		# - update .installed file with new options.
		if [ -f /DietPi/dietpi/.installed ]; then

			index=-2 #lighttpd

			if (( $(dpkg -l | awk '{print $2}' | grep -ci -m1 'apache2') )); then
				index=0
			elif (( $(dpkg -l | awk '{print $2}' | grep -ci -m1 'nginx') )); then
				index=-1
			fi

			cat << _EOF_ >> /DietPi/dietpi/.installed
#DietPi Preference System: Webserver base
INDEX_WEBSERVER_CURRENT $index
INDEX_WEBSERVER_TARGET $index
_EOF_

		fi

		# - Add automation support for Webserver preference to dietpi.txt.
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'AUTO_DietpiSoftware_WebserverIndex=') == 0 )); then
			sed -i "/AUTO_DietpiSoftware_LoggingIndex=/a #Webserver Preference Selection:\n# NB: This will get ignored, if you have manually selected any WEBSERVER_Stacks.\n#    0=Apache2\n#    -1=Nginx\n#    -2=Lighttpd\nAUTO_DietpiSoftware_WebserverIndex=-2" /DietPi/dietpi.txt
		fi
		#-------------------------------------------------------------------------------
		# Possible missing dietpi.txt global vars for < v109 images. Add them if required.
		# - To prevent this from occuring again:
		#	For AUTO_ entries, use sed to insert at specific line
		#	For global VARs, just echo the value to the end of dietpi.txt
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'wifi_hotspot_ssid=') == 0 )); then
			echo -e "wifi_hotspot_ssid=DietPi-HotSpot" >> /DietPi/dietpi.txt
		fi
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'wifi_hotspot_key=') == 0 )); then
			echo -e "wifi_hotspot_key=dietpihotspot" >> /DietPi/dietpi.txt
		fi
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'wifi_hotspot_channel=') == 0 )); then
			echo -e "wifi_hotspot_channel=3" >> /DietPi/dietpi.txt
		fi
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'dietpi_userdata_basedirectory=') == 0 )); then
			echo -e "dietpi_userdata_basedirectory=Auto" >> /DietPi/dietpi.txt
		fi
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'dietpi_emonhub_apikey=') == 0 )); then
			echo -e "dietpi_emonhub_apikey=" >> /DietPi/dietpi.txt
		fi
		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 115 )); then
		#-------------------------------------------------------------------------------
		# Add netdata to existing dietpi.txt automation file
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'AUTO_DietpiSoftware_Install_NETDATA=') == 0 )); then
			sed -i "/AUTO_DietpiSoftware_Install_LINUXDASH=/a AUTO_DietpiSoftware_Install_NETDATA=0" /DietPi/dietpi.txt
		fi

		# + DietPi.txt Proxy settings
		# NB: Always add extra line to cat feed: https://github.com/Fourdee/DietPi/issues/301#issue-151214787
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 '^proxy_address=') == 0 )); then
			cat << _EOF_ >> /DietPi/dietpi.txt

#Proxy settings | System-wide proxy settings. Use dietpi-config > networking options to apply.
proxy_enabled=0
proxy_address=MyProxyServer.com
proxy_port=8080
proxy_username=
proxy_password=
_EOF_
		fi
		#-------------------------------------------------------------------------------
		#Odroid C1 WiFi fix (missing packages): https://github.com/Fourdee/DietPi/issues/273#issuecomment-210410651
		if (( $HW_MODEL == 10 )); then
			apt-get install -y wireless-regdb iw crda wpasupplicant
		fi
		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 116 )); then
		#-------------------------------------------------------------------------------
		#DietPi-Software additions
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'AUTO_DietpiSoftware_Install_MUMBLESERVER=') == 0 )); then
			sed -i "/AUTO_DietpiSoftware_Install_EMONHUB=/a AUTO_DietpiSoftware_Install_MUMBLESERVER=0" /DietPi/dietpi.txt
		fi
		#-------------------------------------------------------------------------------
		#update .installed file to new format
		if [[ -f /DietPi/dietpi/.installed ]]; then
			sed -i -re 's/(^[^#]\S*) (.*)/\1=\2/' /DietPi/dietpi/.installed
		fi

		#update cron jobs to use new .installed format
		cp /DietPi/dietpi/conf/cron.daily_dietpi /etc/cron.daily/dietpi
		chmod +x /etc/cron.daily/dietpi
		cp /DietPi/dietpi/conf/cron.hourly_dietpi /etc/cron.hourly/dietpi
		chmod +x /etc/cron.hourly/dietpi
		#-------------------------------------------------------------------------------
		#ifmetric: https://github.com/Fourdee/DietPi/issues/273#issuecomment-213951519
		apt-get install -y ifmetric
		if (( $(cat /etc/network/interfaces | grep -ci -m1 '^metric ') == 0 )); then
			# - eth
			sed -i "/iface eth$(sed -n 1p /DietPi/dietpi/.network)/a metric 0" /etc/network/interfaces
			# - wlan
			sed -i "/iface wlan$(sed -n 2p /DietPi/dietpi/.network)/a metric 1" /etc/network/interfaces
		fi
		#-------------------------------------------------------------------------------
		#netplug. Resolves issues with unplugging eth and breaking all connections, when WiFi is also active: https://github.com/Fourdee/DietPi/issues/273#issuecomment-215996025
		apt-get install netplug -y
		cat << _EOF_ > /etc/netplug/netplugd.conf
eth*
wlan*
_EOF_
		#-------------------------------------------------------------------------------
		#Roll out allow-hotplug as default: https://github.com/Fourdee/DietPi/issues/305
		# - Active
		#	eth
		sed -i "/^auto eth$(sed -n 1p /DietPi/dietpi/.network)/c\allow-hotplug eth$(sed -n 1p /DietPi/dietpi/.network)" /etc/network/interfaces
		#	wlan
		sed -i "/^auto wlan$(sed -n 2p /DietPi/dietpi/.network)/c\allow-hotplug wlan$(sed -n 2p /DietPi/dietpi/.network)" /etc/network/interfaces
		# - inactive
		#	eth
		sed -i "/^#auto eth$(sed -n 1p /DietPi/dietpi/.network)/c\#allow-hotplug eth$(sed -n 1p /DietPi/dietpi/.network)" /etc/network/interfaces
		#	wlan
		sed -i "/^#auto wlan$(sed -n 2p /DietPi/dietpi/.network)/c\#allow-hotplug wlan$(sed -n 2p /DietPi/dietpi/.network)" /etc/network/interfaces
		#-------------------------------------------------------------------------------
		#apply to all DietPi systems (but targeted at Odroid XU4) - missing WiFi packages.
		apt-get install -y wireless-regdb iw crda wpasupplicant
		#-------------------------------------------------------------------------------
		#Missing line at EOF
		echo -e "" >> /etc/network/interfaces
		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 117 )); then
		#-------------------------------------------------------------------------------
		#DietPi-Software additions:
		# NB: We no longer need to do this.
		#		Users can download and copy the latest dietpi.txt file to SD, prior to boot, which will contain all current automation options.
		#		Theres no need for us to add them in during patching to their dietpi.txt.
		#-------------------------------------------------------------------------------
		#WiFi country code
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'wifi_country_code=') == 0 )); then
			echo -e "\n#WiFi country code. 2 character value (eg GB US DE JP): https://en.wikipedia.org/wiki/ISO_3166-1_alpha-2\nwifi_country_code=" >> /DietPi/dietpi.txt
		fi
		#-------------------------------------------------------------------------------
		#Remove _ from installed file: https://github.com/Fourdee/DietPi/issues/322
		if [ -f /DietPi/dietpi/.installed ]; then
			sed -i '/^_$/d' /DietPi/dietpi/.installed
		fi
		#-------------------------------------------------------------------------------
		#Subsonic now has two installation versions, v5 being the previous installation option.: https://github.com/Fourdee/DietPi/issues/330
		if [ -f /DietPi/dietpi/.installed ]; then
			sed -i 's/^SUBSONIC=/SUBSONIC5=/' /DietPi/dietpi/.installed
		fi
		#-------------------------------------------------------------------------------
		#Patch PineA64 to include xz-utils for firmware upgrades (only needed w/ alpha v118 image
		if (( $HW_MODEL >= 40 && $HW_MODEL <= 42 )); then
			apt-get update
			apt-get install -y --no-install-recommends xz-utils

			/usr/local/sbin/pine64_update_uboot.sh
			/usr/local/sbin/pine64_update_kernel.sh
			/usr/local/sbin/pine64_fix_whatever.sh
		fi
		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 118 )); then
		#-------------------------------------------------------------------------------
		#Transmission, service starts before network via SystemD, instead of "dietpi-services start": https://github.com/Fourdee/DietPi/issues/350
		if [ -f /DietPi/dietpi/.installed ] &&
			(( $DISTRO == 3 )) &&
			(( $( cat /DietPi/dietpi/.installed | grep -ci -m1 '^TRANSMISSION=2' ) )); then

			rm /etc/init.d/transmission-daemon
			rm /etc/systemd/system/transmission-daemon.service
			cat << _EOF_ > /etc/systemd/system/transmission-daemon.service
[Unit]
Description=Barebones transmission-daemon service
DefaultDependencies=no

[Service]
Type=oneshot
RemainAfterExit=yes
ExecStart=/usr/bin/transmission-daemon --config-dir /var/lib/transmission-daemon/info
ExecStop=/usr/bin/killall -w transmission-daemon
StandardOutput=tty

[Install]
WantedBy=multi-user.target
_EOF_
			systemctl enable transmission-daemon.service
			systemctl daemon-reload
			/DietPi/dietpi/dietpi-services disable

		fi
		#-------------------------------------------------------------------------------
		#dietpi.txt global vnc settings
		if (( ! $(cat /DietPi/dietpi.txt | grep -ci -m1 '^dietpi_vncserver_height=') )); then
			echo -e "\n#VNC Server Options\ndietpi_vncserver_width=1280\ndietpi_vncserver_height=720\ndietpi_vncserver_depth=16\ndietpi_vncserver_display=0" >> /DietPi/dietpi.txt
		fi
		#-------------------------------------------------------------------------------
		#VNC servers, now start automatically during boot via service.
		if [ -f /DietPi/dietpi/.installed ] &&
			(( $( cat /DietPi/dietpi/.installed | grep -ci -m1 '^TIGHTVNCSERVER=2' ) )); then

			#Wheezy
			if (( $DISTRO == 1 )); then

				cat << _EOF_ > /etc/init.d/vncserver
#!/bin/bash -e
### BEGIN INIT INFO
# Provides:          VNC server
# Required-Start:    \$all
# Should-Start:
# Required-Stop:	 \$local_fs \$network
# Should-Stop:
# Default-Start:     2 3 4 5
# Default-Stop:      0 1 6
# Description:       DietPi VNC server control
### END INIT INFO

#Wheezy, to prevent "vncserver: The HOME/USER environment variable is not set"
export USER=root
export HOME='/root'

start(){

	/usr/local/bin/vncserver start

}

stop(){

	/usr/local/bin/vncserver stop

}

case "\$1" in
	start)
		start
	;;
	stop)
		stop
	;;
	restart)
		stop
		start
	;;
	*)
		echo "Usage: \$0 {start|stop|restart}"
	;;
esac
_EOF_

				chmod +x /etc/init.d/vncserver
				update-rc.d vncserver defaults 00 80


			#Jessie
			elif (( $DISTRO == 3 )); then

				cat << _EOF_ > /etc/systemd/system/vncserver.service
[Unit]
Description=Manage VNC Server
After=dietpi-service.service
After=rc.local.service

[Service]
Type=idle
RemainAfterExit=yes
ExecStart=/bin/bash /usr/local/bin/vncserver start
ExecStop=/bin/bash /usr/local/bin/vncserver stop
User=root

[Install]
WantedBy=multi-user.target
_EOF_

				systemctl enable vncserver.service
				systemctl daemon-reload

			fi

			# - Both
			cat << _EOF_ > /usr/local/bin/vncserver
#!/bin/bash

#Globals
VNC_INSTALLED=0
BINARY_FP=0

WIDTH=\$(cat /DietPi/dietpi.txt | grep -m1 '^dietpi_vncserver_width=' | sed 's/.*=//')
HEIGHT=\$(cat /DietPi/dietpi.txt | grep -m1 '^dietpi_vncserver_height=' | sed 's/.*=//')
DEPTH=\$(cat /DietPi/dietpi.txt | grep -m1 '^dietpi_vncserver_depth=' | sed 's/.*=//')
DISPLAY=\$(cat /DietPi/dietpi.txt | grep -m1 '^dietpi_vncserver_display=' | sed 's/.*=//')

#TightVNC or VNC4server?
if [ -f /usr/bin/vnc4server ]; then
    BINARY_FP='/usr/bin/vnc4server'
    VNC_INSTALLED=1
elif [ -f /usr/bin/vncserver ]; then
    BINARY_FP='/usr/bin/vncserver'
    VNC_INSTALLED=1
fi

#Exit if no VNC binary found
if (( ! \$VNC_INSTALLED )); then
    exit 1
fi

case "\$1" in
    start)
        \$BINARY_FP :\$DISPLAY -geometry \$WIDTH'x'\$HEIGHT -depth \$DEPTH
        ;;

    stop)
        \$BINARY_FP -kill :\$DISPLAY
        ;;

esac

exit 0
_EOF_
			chmod +x /usr/local/bin/vncserver

		fi
		#-------------------------------------------------------------------------------
		#Removal of VNC server from DietPi-Autostart. Reset to console, manual login.
		if (( $(cat /DietPi/dietpi/.dietpi-autostart_index) == 6 )); then
			echo 0 > /DietPi/dietpi/.dietpi-autostart_index
		fi
		#-------------------------------------------------------------------------------
		#dietpi.txt | Serial console global var
		# - Set this to 0 disabled (the previous default for all DietPi images). Future images will have this enabled by default.
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'serial_console_enabled=') == 0 )); then
			echo -e "\n#Serial Console: If you dont know what this is, you can safely disable it (=0) to reduce system resource usage.\nserial_console_enabled=0" >> /DietPi/dietpi.txt
		fi
		#-------------------------------------------------------------------------------
		#dietpi.txt | Soundcard global var
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'soundcard=') == 0 )); then
			echo -e "\n#Soundcard\nsoundcard=none" >> /DietPi/dietpi.txt
		fi
		#-------------------------------------------------------------------------------
		#Odroid C2 boot.ini changes: https://github.com/Fourdee/DietPi/issues/366#issue-157399983
		#	I dont want to risk patching these additional options in, so lets overwrite the users boot.ini with the new one.
		if (( $HW_MODEL == 12 )); then

			DEBIAN_FRONTEND='noninteractive' apt-get upgrade -y linux-headers-arm64-odroid-c2 linux-image-arm64-odroid-c2

			whiptail --title "Kernel Upgrade" --msgbox "If the next screen shows a Yes/No prompt. Select No." 8 60
			DEBIAN_FRONTEND='noninteractive' apt-get autoremove --purge -y

			# - Because removing 3.14.29 also removes 3.14.65 (most likley same locations) we need to reinstall 3.14.65+
			DEBIAN_FRONTEND='noninteractive' apt-get install -y --reinstall linux-headers-3.14.65+ linux-image-3.14.65+

			wget https://raw.githubusercontent.com/Fourdee/DietPi/e8e0edf7193c61d6084bf252397561081e335dc5/boot_c2.ini -O /DietPi/boot.ini

		fi
		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 119 )); then
		#-------------------------------------------------------------------------------
		#RPi 3 75 thermal limit: https://github.com/Fourdee/DietPi/issues/356#issuecomment-223282185
		if (( $HW_MODEL == 3 )); then

			sed -i '/temp_limit=/c\temp_limit=75' /DietPi/config.txt

		fi
		#-------------------------------------------------------------------------------
		#Disable internal WiFi and BT by default on new installs
		if [ ! -f /DietPi/dietpi/.installed ]; then

			# - changed from RPi3 only script to all devices, remove old references
			rm /etc/modprobe.d/disable_rpi3_bt.conf &> /dev/null
			rm /etc/modprobe.d/disable_rpi3_wifi.conf &> /dev/null

			/DietPi/dietpi/func/dietpi-set_hardware bluetooth disable

			#enable WiFi for automation
			if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'Wifi_Enabled=1') )); then
				/DietPi/dietpi/func/dietpi-set_hardware wifi enable
			else
				/DietPi/dietpi/func/dietpi-set_hardware wifi disable
			fi

		fi
		#-------------------------------------------------------------------------------
		#Pine A64 image, disable systemd-timesyncd as we use ntp/d. New installs only.
		if (( $HW_MODEL >= 40 && $HW_MODEL <= 42 )) && [ ! -f /DietPi/dietpi/.installed ]; then
			systemctl disable systemd-timesyncd
			systemctl mask systemd-timesyncd
		fi
		#-------------------------------------------------------------------------------
		#Netplug is now installed on demand in dietpi-config, when both adapters are enabled.
		apt-get purge netplug -y
		#-------------------------------------------------------------------------------
		#DietPi-Cloudshell - New poweroff screen at specific time
		if [ -f /DietPi/dietpi/.dietpi-cloudshell ]; then
			sed -i '7s/.*/0/' /DietPi/dietpi/.dietpi-cloudshell #Enabled?
			sed -i '8s/.*/22/' /DietPi/dietpi/.dietpi-cloudshell #Start time (hour)
			sed -i '9s/.*/8/' /DietPi/dietpi/.dietpi-cloudshell #End time (hour)
		fi
		#-------------------------------------------------------------------------------
		#Pine A64, now using fbturbo driver: https://github.com/Fourdee/DietPi/issues/380
		if (( $HW_MODEL >= 40 && $HW_MODEL <= 42 )) &&
			[ -f /DietPi/dietpi/.installed ] &&
			(( $( cat /DietPi/dietpi/.installed | grep -ci -m1 '^XSERVERXORG=2' ) )); then

			wget http://dietpi.com/downloads/binaries/all/libump_1-1_arm64.deb -O package.deb
			dpkg -i package.deb
			rm package.deb

			wget http://dietpi.com/downloads/binaries/all/xf86-video-fbturbo_1-1_arm64.deb -O package.deb
			dpkg -i package.deb
			rm package.deb

		fi
		#-------------------------------------------------------------------------------
		#Always ensure dietpi_userdata directory exists
		mkdir -p /mnt/dietpi_userdata &> /dev/null

		#Setup dietpi_userdata symlink for existing installs, if not on flash drive
		if [ -f /DietPi/dietpi/.installed ]; then

			DIETPI_USERDATA_BASEDIRECTORY=$(cat /DietPi/dietpi.txt | grep -m1 '^dietpi_userdata_basedirectory=' | sed 's/.*=//' | tr '[:upper:]' '[:lower:]')

			if [ -n "$DIETPI_USERDATA_BASEDIRECTORY" ]; then

				#Auto
				if [ "$DIETPI_USERDATA_BASEDIRECTORY" = "auto" ]; then

					#USBDRIVE
					if (( $(cat /DietPi/dietpi/.installed | grep -ci -m1 'USBDRIVE=2') && $(df | grep -ci -m1 '/mnt/usb_1') )); then
						/DietPi/dietpi/func/dietpi-set_userdata /mnt/dietpi_userdata /mnt/usb_1
					fi

				#CUSTOM
				else
					/DietPi/dietpi/func/dietpi-set_userdata /mnt/dietpi_userdata "$DIETPI_USERDATA_BASEDIRECTORY"
				fi

				# - dietpi-set_userdata restarts services, so stop them.
				/DietPi/dietpi/dietpi-services stop

			else

				read -p "Error: Unable to setup DietPi Userdata directories. dietpi_userdata_basedirectory= is missing or invalid value in dietpi.txt. It is highly recommended you backup any personal data on this system, then reinstall DietPi using the latest image available from http://dietpi.com/download. Press any key to continue..."

			fi

		fi
		#-------------------------------------------------------------------------------
		#xz-utils missing from some images, required for decompress tar.xz support.
		apt-get install -y xz-utils
		#-------------------------------------------------------------------------------
		#I left the serial console enabled for all the v120 images (my bad). Disable if not enabled in dietpi.txt
		if (( ! $(cat /DietPi/dietpi.txt | grep -ci -m1 '^serial_console_enabled=1') )); then
			/DietPi/dietpi/func/dietpi-set_hardware serialconsole disable
		fi
		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 120 )); then
		#-------------------------------------------------------------------------------
		#Update cron daily (Added daily filesystem TRIM for capable devices, eg: flash)
		cp /DietPi/dietpi/conf/cron.daily_dietpi /etc/cron.daily/dietpi
		chmod +x /etc/cron.daily/dietpi
		#-------------------------------------------------------------------------------
		#Xterm now installed by default with xserverxorg: https://github.com/Fourdee/DietPi/issues/388
		if [ -f /DietPi/dietpi/.installed ]; then

			if (( $(cat /DietPi/dietpi/.installed | grep -ci -m1 'XSERVERXORG=2') )); then
				apt-get install xterm -y
			fi

			# Mate: https://github.com/Fourdee/DietPi/issues/388
			if (( $(cat /DietPi/dietpi/.installed | grep -ci -m1 'DESKTOP_MATE=2') )); then

				# - Set execute to prevent "untrusted" prompt in Mate, and possibily other desktops.
				chmod +x /usr/share/applications/*

				# - remove pcmanfm link
				rm "$HOME"/Desktop/pcmanfm.desktop

			fi

		fi
		#-------------------------------------------------------------------------------
		#C2 X11 GPU/VPU patches: https://github.com/Fourdee/DietPi/issues/399
		# - boot.ini
		if (( $HW_MODEL == 12 )); then

			if [ -f /DietPi/dietpi/.installed ]; then

				whiptail --title "boot.ini updated" --msgbox "/DietPi/boot.ini has been overwritten and updated with the latest C2 options. Values such as display resolution and serial console have been reset.\nPlease check the file and adjust as needed." 10 70

			fi

			wget http://raw.githubusercontent.com/Fourdee/DietPi/f289eb0b3d1ab54980adf8e5d025b46d4c55c85d/boot_c2.ini -O /DietPi/boot.ini

			# - Xserver/LXDE
			if [ -f /DietPi/dietpi/.installed ]; then

				# - Xserver
				if (( $(cat /DietPi/dietpi/.installed | grep -ci -m1 'XSERVERXORG=2') )); then

					# - Update/Upgrade apt
					/DietPi/dietpi/dietpi-apt-get_update 2
					AGU

					# - Reinstall all packages, including the X11 additions (xf86-video-mali-odroid libump-odroid)
					apt-get install -y xcompmgr aml-libs-odroid mali450-odroid xf86-video-mali-odroid libump-odroid --no-install-recommends
					cp /DietPi/dietpi/conf/xorg_c2.conf /etc/X11/xorg.conf

				fi

				# - LXDE xcompmgr
				if (( $(cat /DietPi/dietpi/.installed | grep -ci -m1 'DESKTOP_LXDE=2') )); then

					cat << _EOF_ > /etc/xdg/lxsession/LXDE/autostart
xcompmgr -a
@lxpanel --profile LXDE
@pcmanfm --desktop --profile LXDE
@xscreensaver -no-splash
_EOF_

				fi

			fi

		fi
		#-------------------------------------------------------------------------------
		#Weekly cronjob to update Pihole adlist
		if [ -f /DietPi/dietpi/.installed ] && (( $(cat /DietPi/dietpi/.installed | grep -ci -m1 'PIHOLE=2') )); then

			cat << _EOF_ > /etc/cron.weekly/pihole_adlist_update
#!/bin/bash
{
	service dnsmasq stop

	echo -e "--------------------------------------------------------------------\n\n\$(date)\nDietPi - Running weekly adlist update" >> /var/log/pihole.log
	/usr/local/bin/gravity.sh &>> /var/log/pihole.log
	echo -e "--------------------------------------------------------------------\n" >> /var/log/pihole.log

	service dnsmasq start

	exit 0
}

_EOF_

			chmod +x /etc/cron.weekly/pihole_adlist_update

		fi
		#-------------------------------------------------------------------------------
		#MineOS requires rsync: https://github.com/Fourdee/DietPi/issues/403
		if [ -f /DietPi/dietpi/.installed ] && (( $(cat /DietPi/dietpi/.installed | grep -ci -m1 'MINEOS=2') )); then

			apt-get install -y rsync

		fi
		#-------------------------------------------------------------------------------


	elif (( $VERSION_CURRENT == 121 )); then
		#-------------------------------------------------------------------------------
		echo -e "Nothing here" &> /dev/null
 		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 122 )); then
		#-------------------------------------------------------------------------------
		#Pine a64 resolution option in dietpi-config: https://github.com/Fourdee/DietPi/issues/398
		if (( $HW_MODEL >= 40 && $HW_MODEL <= 42 )); then

			if (( ! $(cat /DietPi/uEnv.txt | grep -ci -m1 '^optargs=disp.screen0_output_mode=') )); then

				echo -e "\noptargs=disp.screen0_output_mode=1080p60" >> /DietPi/uEnv.txt

			fi

		fi
 		#-------------------------------------------------------------------------------
		#MPD software mixer control
		if [ -f /DietPi/dietpi/.installed ] && (( $(cat /DietPi/dietpi/.installed | grep -ci -m1 'HIFI=2') )); then

			sed -i '/mixer_device/c\mixer_type "software"' /etc/mpd.conf

		fi
		#-------------------------------------------------------------------------------
		#PiHole, prevent warning of a "file not found" when running gravity.sh: https://github.com/Fourdee/DietPi/issues/311#issuecomment-230342269
		# + log-async for rsyslog
		if [ -f /DietPi/dietpi/.installed ] && (( $(cat /DietPi/dietpi/.installed | grep -ci -m1 'PIHOLE=2') )); then

			echo -e "#nothing here" > /etc/dnsmasq.d/01-pihole.conf

			if (( ! $(cat /etc/dnsmasq.conf | grep -ci -m1 'log-async') )); then

				echo -e "log-async" >> /etc/dnsmasq.conf

			fi

		fi
		#-------------------------------------------------------------------------------
		#RPi Monitor USB drive patch
		if [ -f /DietPi/dietpi/.installed ] &&
			(( $(cat /DietPi/dietpi/.installed | grep -ci -m1 'RPIMONITOR=2') )) &&
			(( $(cat /DietPi/dietpi/.installed | grep -ci -m1 'USBDRIVE=2') )) &&
			(( ! $(cat /etc/rpimonitor/data.conf | grep -ci -m1 'usb_hdd.conf') )); then

			sed -i '\/include=\/etc\/rpimonitor\/template\/sdcard.conf/a include=\/etc\/rpimonitor\/template\/usb_hdd.conf' /etc/rpimonitor/data.conf

			cat << _EOF_ > /etc/rpimonitor/template/usb_hdd.conf
########################################################################
# Extract USB HDD (sda1) information
#  Page: 1
#  Information               Status     Statistics
#  - USBHDD1 total          - yes      - yes
#  - USBHDD1 used           - yes      - yes
########################################################################
static.10.name=usbhdd_total
static.10.source=df -t ext4
static.10.regexp=sda1\s+(\d+)
static.10.postprocess=\$1/1024

dynamic.14.name=usbhdd_used
dynamic.14.source=df -t ext4
dynamic.14.regexp=sda1\s+\d+\s+(\d+)
dynamic.14.postprocess=\$1/1024
dynamic.14.rrd=GAUGE

web.status.1.content.9.name=USB HDD
web.status.1.content.9.icon=usb_hdd.png
web.status.1.content.9.line.1="<b>/sda1</b> Used: <b>"+KMG(data.usbhdd_used,'M')+"</b> (<b>"+Percent(data.udbhdd_used,data.usbhdd_total,'M')+"</b>) Free: <b>"+KMG(data.usbhdd_total-data.usbhdd_used,'M')+ "</b> Total: <b>"+ KMG(data.usbhdd_total,'M') +"</b>"
web.status.1.content.9.line.2=ProgressBar(data.usbhdd_used,data.usbhdd_total)

web.statistics.1.content.9.name=USB HDD
web.statistics.1.content.9.graph.1=usbhdd_total
web.statistics.1.content.9.graph.2=usbhdd_used
web.statistics.1.content.9.ds_graph_options.usbhdd_total.label=USB HDD total space (MB)
web.statistics.1.content.9.ds_graph_options.usbhdd_total.color="#FF7777"
web.statistics.1.content.9.ds_graph_options.usbhdd_used.label=USB HDD used space (MB)
web.statistics.1.content.9.ds_graph_options.usbhdd_used.lines={ fill: true }
web.statistics.1.content.9.ds_graph_options.usbhdd_used.color="#7777FF"
_EOF_
		fi
 		#-------------------------------------------------------------------------------
		#Kodi add NFS support:
		if [ -f /DietPi/dietpi/.installed ] && (( $(cat /DietPi/dietpi/.installed | grep -ci -m1 'KODI=2') )); then

			apt-get install -y libnfs4

		fi
		#-------------------------------------------------------------------------------
		#Odroid C2, define default pulseaudio sink: https://github.com/Fourdee/DietPi/issues/415
		if (( $HW_MODEL == 12 )) &&
			[ -f /DietPi/dietpi/.installed ] &&
			(( $(cat /DietPi/dietpi/.installed | grep -ci -m1 'DESKTOP_MATE=2') )) &&
			(( ! $(cat /etc/pulse/default.pa | grep -ci -m1 '^set-default-sink alsa_output.platform-odroid_hdmi.37.analog-stereo') )); then

			echo -e "set-default-sink alsa_output.platform-odroid_hdmi.37.analog-stereo" >> /etc/pulse/default.pa

		fi
		#-------------------------------------------------------------------------------
		#ARMbian images, install armbian repo and update packages
		if (( $HW_MODEL == 30 || $HW_MODEL == 50 || $HW_MODEL == 51 )) &&
			[ ! -f /proc/sunxi_debug/sunxi_debug ]; then # Skip the replaced OPi PC loboris image.

			echo "deb http://apt.armbian.com jessie main" > /etc/apt/sources.list.d/armbian.list
			apt-key adv --keyserver keys.gnupg.net --recv-keys 0x93D6889F9F0E78D5
			apt-get update

			# - remove ye-olde packages
			apt-get purge -y armbian-firmware

			#BPi m2+
			if (( $HW_MODEL == 50 )); then

				apt-get install -y linux-u-boot-bananapim2plus-default linux-firmware-image-sun8i linux-image-sun8i

			#OPi PC
			elif (( $HW_MODEL == 30 )); then

				# - remove ye-olde packages
				apt-get purge -y linux-jessie-root-orangepih3 linux-u-boot-orangepih3-default

				apt-get install -y linux-u-boot-orangepipc-default linux-firmware-image-sun8i linux-image-sun8i

			#BPi pro
			elif (( $HW_MODEL == 51 )); then

				apt-get install -y linux-image-sun7i linux-firmware-image-sun7i linux-u-boot-bananapipro-default

			fi

		fi

		#-------------------------------------------------------------------------------
		#alias sudo='sudo ' # https://github.com/Fourdee/DietPi/issues/424#issuecomment-232016646
		if (( ! $(cat /etc/bash.bashrc | grep -ci -m1 '^alias sudo=') )); then

			echo -e "alias sudo='sudo ' # https://github.com/Fourdee/DietPi/issues/424" >> /etc/bash.bashrc

		fi
		#-------------------------------------------------------------------------------
		#RPi add dtparam=spi=off to config by default
		if (( $HW_MODEL < 10 &&
			! $(cat /DietPi/config.txt | grep -ci -m1 'dtparam=spi=') )); then

			echo -e "\ndtparam=spi=off" >> /DietPi/config.txt

		fi

		#-------------------------------------------------------------------------------
		#DietPi-Config > LCD Panel addon
		if (( ! $(cat /DietPi/dietpi.txt | grep -ci -m1 '^lcdpanel=') )); then

			echo -e "\nlcdpanel=none" >> /DietPi/dietpi.txt

		fi
		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 123 )); then
		#-------------------------------------------------------------------------------
		#Pine remove vim-* (was left on latest image) for new installations.
		if [ ! -f /DietPi/dietpi/.installed ] && (( $HW_MODEL >= 40 && $HW_MODEL <= 42 )); then

			apt-get purge -y vim-common vim-tiny

		fi
		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 124 )); then
		#-------------------------------------------------------------------------------
		#Disable daily fstrim until testing can be performed to ensure this isnt causing the recent influx of filesystem corruptions.
		cp /DietPi/dietpi/conf/cron.daily_dietpi /etc/cron.daily/dietpi
		chmod +x /etc/cron.daily/dietpi
		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 125 )); then
		#-------------------------------------------------------------------------------
		#libcurl3-gnutls required for C2. But lets apply to all: https://github.com/Fourdee/DietPi/issues/446
		if [ -f /DietPi/dietpi/.installed ] &&
			(( $( cat /DietPi/dietpi/.installed | grep -ci -m1 '^KODI=2' ) )); then

			apt-get install -y libcurl3-gnutls

		fi
		#-------------------------------------------------------------------------------
		#C2 remove asound.conf for hdmi: https://github.com/Fourdee/DietPi/issues/447
		if (( $HW_MODEL == 12 )) && [ -f /etc/asound.conf ] &&
			(( $(cat /etc/asound.conf | grep -ci -m1 'format S32_LE') )); then

			rm /etc/asound.conf

		fi
		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 126 )); then
		#-------------------------------------------------------------------------------
		#NanoPi Neo, left test account on image, remove it
		if (( $HW_MODEL == 60 )); then

			userdel -f test

		fi
		#-------------------------------------------------------------------------------
		#remove dietpi-uninstall from bash alias
		sed -i '/alias dietpi-uninstall/d' /etc/bash.bashrc
		#-------------------------------------------------------------------------------
		#Update dietpi.txt automation var name change
		sed -i 's/AUTO_Install_Index=/AUTO_Install_Enable=/g' /DietPi/dietpi.txt
		#-------------------------------------------------------------------------------
		#patch: Convert all .installed files to the new array system
		if [ -f /DietPi/dietpi/.installed ]; then

			sed -i "s/^SSHCLIENT=/aSOFTWARE_INSTALL_STATE[0]=/g" /DietPi/dietpi/.installed
			sed -i "s/^SMBCLIENT=/aSOFTWARE_INSTALL_STATE[1]=/g" /DietPi/dietpi/.installed
			sed -i "s/^CURLFTPFS=/aSOFTWARE_INSTALL_STATE[2]=/g" /DietPi/dietpi/.installed
			sed -i "s/^MIDNIGHTCOMMANDER=/aSOFTWARE_INSTALL_STATE[3]=/g" /DietPi/dietpi/.installed
			sed -i "s/^VIFM=/aSOFTWARE_INSTALL_STATE[4]=/g" /DietPi/dietpi/.installed
			sed -i "s/^ALSABASE=/aSOFTWARE_INSTALL_STATE[5]=/g" /DietPi/dietpi/.installed
			sed -i "s/^XSERVERXORG=/aSOFTWARE_INSTALL_STATE[6]=/g" /DietPi/dietpi/.installed
			sed -i "s/^FFMPEG=/aSOFTWARE_INSTALL_STATE[7]=/g" /DietPi/dietpi/.installed
			sed -i "s/^ORACLEJAVA=/aSOFTWARE_INSTALL_STATE[8]=/g" /DietPi/dietpi/.installed
			sed -i "s/^NODEJS=/aSOFTWARE_INSTALL_STATE[9]=/g" /DietPi/dietpi/.installed
			sed -i "s/^IFTOP=/aSOFTWARE_INSTALL_STATE[10]=/g" /DietPi/dietpi/.installed
			sed -i "s/^IPTRAF=/aSOFTWARE_INSTALL_STATE[11]=/g" /DietPi/dietpi/.installed
			sed -i "s/^IPERF=/aSOFTWARE_INSTALL_STATE[12]=/g" /DietPi/dietpi/.installed
			sed -i "s/^MTRTINY=/aSOFTWARE_INSTALL_STATE[13]=/g" /DietPi/dietpi/.installed
			sed -i "s/^NLOAD=/aSOFTWARE_INSTALL_STATE[14]=/g" /DietPi/dietpi/.installed
			sed -i "s/^TCPDUMP=/aSOFTWARE_INSTALL_STATE[15]=/g" /DietPi/dietpi/.installed
			sed -i "s/^BUILDESSENTIAL=/aSOFTWARE_INSTALL_STATE[16]=/g" /DietPi/dietpi/.installed
			sed -i "s/^GITCLIENT=/aSOFTWARE_INSTALL_STATE[17]=/g" /DietPi/dietpi/.installed
			sed -i "s/^GNUEMACS=/aSOFTWARE_INSTALL_STATE[18]=/g" /DietPi/dietpi/.installed
			sed -i "s/^JED=/aSOFTWARE_INSTALL_STATE[19]=/g" /DietPi/dietpi/.installed
			sed -i "s/^VIMFULL=/aSOFTWARE_INSTALL_STATE[20]=/g" /DietPi/dietpi/.installed
			sed -i "s/^VIMTINY=/aSOFTWARE_INSTALL_STATE[21]=/g" /DietPi/dietpi/.installed
			sed -i "s/^QUITERSS=/aSOFTWARE_INSTALL_STATE[22]=/g" /DietPi/dietpi/.installed
			sed -i "s/^DESKTOP_LXDE=/aSOFTWARE_INSTALL_STATE[23]=/g" /DietPi/dietpi/.installed
			sed -i "s/^DESKTOP_MATE=/aSOFTWARE_INSTALL_STATE[24]=/g" /DietPi/dietpi/.installed
			sed -i "s/^DESKTOP_XFCE=/aSOFTWARE_INSTALL_STATE[25]=/g" /DietPi/dietpi/.installed
			sed -i "s/^DESKTOP_GNUSTEP=/aSOFTWARE_INSTALL_STATE[26]=/g" /DietPi/dietpi/.installed
			sed -i "s/^TIGHTVNCSERVER=/aSOFTWARE_INSTALL_STATE[27]=/g" /DietPi/dietpi/.installed
			sed -i "s/^VNC4SERVER=/aSOFTWARE_INSTALL_STATE[28]=/g" /DietPi/dietpi/.installed
			sed -i "s/^XRDP=/aSOFTWARE_INSTALL_STATE[29]=/g" /DietPi/dietpi/.installed
			sed -i "s/^NOMACHINE=/aSOFTWARE_INSTALL_STATE[30]=/g" /DietPi/dietpi/.installed
			sed -i "s/^KODI=/aSOFTWARE_INSTALL_STATE[31]=/g" /DietPi/dietpi/.installed
			sed -i "s/^HIFI=/aSOFTWARE_INSTALL_STATE[32]=/g" /DietPi/dietpi/.installed
			sed -i "s/^SUBSONIC5=/aSOFTWARE_INSTALL_STATE[33]=/g" /DietPi/dietpi/.installed
			sed -i "s/^SUBSONIC6=/aSOFTWARE_INSTALL_STATE[34]=/g" /DietPi/dietpi/.installed
			sed -i "s/^SQUEEZEBOXSERVER=/aSOFTWARE_INSTALL_STATE[35]=/g" /DietPi/dietpi/.installed
			sed -i "s/^SQUEEZELITE=/aSOFTWARE_INSTALL_STATE[36]=/g" /DietPi/dietpi/.installed
			sed -i "s/^SHAIRPORTSYNC=/aSOFTWARE_INSTALL_STATE[37]=/g" /DietPi/dietpi/.installed
			sed -i "s/^BRUTEFIR=/aSOFTWARE_INSTALL_STATE[38]=/g" /DietPi/dietpi/.installed
			sed -i "s/^MINIDLNA=/aSOFTWARE_INSTALL_STATE[39]=/g" /DietPi/dietpi/.installed
			sed -i "s/^AMPACHE=/aSOFTWARE_INSTALL_STATE[40]=/g" /DietPi/dietpi/.installed
			sed -i "s/^EMBYSERVER=/aSOFTWARE_INSTALL_STATE[41]=/g" /DietPi/dietpi/.installed
			sed -i "s/^PLEXMEDIASERVER=/aSOFTWARE_INSTALL_STATE[42]=/g" /DietPi/dietpi/.installed
			sed -i "s/^MUMBLESERVER=/aSOFTWARE_INSTALL_STATE[43]=/g" /DietPi/dietpi/.installed
			sed -i "s/^TRANSMISSION=/aSOFTWARE_INSTALL_STATE[44]=/g" /DietPi/dietpi/.installed
			sed -i "s/^DELUGE=/aSOFTWARE_INSTALL_STATE[45]=/g" /DietPi/dietpi/.installed
			sed -i "s/^QBITTORRENT=/aSOFTWARE_INSTALL_STATE[46]=/g" /DietPi/dietpi/.installed
			sed -i "s/^OWNCLOUD=/aSOFTWARE_INSTALL_STATE[47]=/g" /DietPi/dietpi/.installed
			sed -i "s/^PYDIO=/aSOFTWARE_INSTALL_STATE[48]=/g" /DietPi/dietpi/.installed
			sed -i "s/^GOGS=/aSOFTWARE_INSTALL_STATE[49]=/g" /DietPi/dietpi/.installed
			sed -i "s/^SYNCTHING=/aSOFTWARE_INSTALL_STATE[50]=/g" /DietPi/dietpi/.installed
			sed -i "s/^OPENTYRIAN=/aSOFTWARE_INSTALL_STATE[51]=/g" /DietPi/dietpi/.installed
			sed -i "s/^CUBERITE=/aSOFTWARE_INSTALL_STATE[52]=/g" /DietPi/dietpi/.installed
			sed -i "s/^MINEOS=/aSOFTWARE_INSTALL_STATE[53]=/g" /DietPi/dietpi/.installed
			sed -i "s/^PHPBB=/aSOFTWARE_INSTALL_STATE[54]=/g" /DietPi/dietpi/.installed
			sed -i "s/^WORDPRESS=/aSOFTWARE_INSTALL_STATE[55]=/g" /DietPi/dietpi/.installed
			sed -i "s/^PHPIMAGEGALLERY=/aSOFTWARE_INSTALL_STATE[56]=/g" /DietPi/dietpi/.installed
			sed -i "s/^BAIKAL=/aSOFTWARE_INSTALL_STATE[57]=/g" /DietPi/dietpi/.installed
			sed -i "s/^OPENBAZAAR=/aSOFTWARE_INSTALL_STATE[58]=/g" /DietPi/dietpi/.installed
			sed -i "s/^DIETPICAM=/aSOFTWARE_INSTALL_STATE[59]=/g" /DietPi/dietpi/.installed
			sed -i "s/^WIFIHOTSPOT=/aSOFTWARE_INSTALL_STATE[60]=/g" /DietPi/dietpi/.installed
			sed -i "s/^TORHOTSPOT=/aSOFTWARE_INSTALL_STATE[61]=/g" /DietPi/dietpi/.installed
			sed -i "s/^DIETPICLOUDSHELL=/aSOFTWARE_INSTALL_STATE[62]=/g" /DietPi/dietpi/.installed
			sed -i "s/^LINUXDASH=/aSOFTWARE_INSTALL_STATE[63]=/g" /DietPi/dietpi/.installed
			sed -i "s/^PHPSYSINFO=/aSOFTWARE_INSTALL_STATE[64]=/g" /DietPi/dietpi/.installed
			sed -i "s/^NETDATA=/aSOFTWARE_INSTALL_STATE[65]=/g" /DietPi/dietpi/.installed
			sed -i "s/^RPIMONITOR=/aSOFTWARE_INSTALL_STATE[66]=/g" /DietPi/dietpi/.installed
			sed -i "s/^NOIPDYNDNS=/aSOFTWARE_INSTALL_STATE[67]=/g" /DietPi/dietpi/.installed
			sed -i "s/^WEAVED=/aSOFTWARE_INSTALL_STATE[68]=/g" /DietPi/dietpi/.installed
			sed -i "s/^RPIGPIO=/aSOFTWARE_INSTALL_STATE[69]=/g" /DietPi/dietpi/.installed
			sed -i "s/^WIRINGPI=/aSOFTWARE_INSTALL_STATE[70]=/g" /DietPi/dietpi/.installed
			sed -i "s/^WEBIOPI=/aSOFTWARE_INSTALL_STATE[71]=/g" /DietPi/dietpi/.installed
			sed -i "s/^RPII2C=/aSOFTWARE_INSTALL_STATE[72]=/g" /DietPi/dietpi/.installed
			sed -i "s/^FAIL2BAN=/aSOFTWARE_INSTALL_STATE[73]=/g" /DietPi/dietpi/.installed
			sed -i "s/^WEBSERVER_LAMP=/aSOFTWARE_INSTALL_STATE[74]=/g" /DietPi/dietpi/.installed
			sed -i "s/^WEBSERVER_LASP=/aSOFTWARE_INSTALL_STATE[75]=/g" /DietPi/dietpi/.installed
			sed -i "s/^WEBSERVER_LAAP=/aSOFTWARE_INSTALL_STATE[76]=/g" /DietPi/dietpi/.installed
			sed -i "s/^WEBSERVER_LEMP=/aSOFTWARE_INSTALL_STATE[77]=/g" /DietPi/dietpi/.installed
			sed -i "s/^WEBSERVER_LESP=/aSOFTWARE_INSTALL_STATE[78]=/g" /DietPi/dietpi/.installed
			sed -i "s/^WEBSERVER_LEAP=/aSOFTWARE_INSTALL_STATE[79]=/g" /DietPi/dietpi/.installed
			sed -i "s/^WEBSERVER_LLMP=/aSOFTWARE_INSTALL_STATE[80]=/g" /DietPi/dietpi/.installed
			sed -i "s/^WEBSERVER_LLSP=/aSOFTWARE_INSTALL_STATE[81]=/g" /DietPi/dietpi/.installed
			sed -i "s/^WEBSERVER_LLAP=/aSOFTWARE_INSTALL_STATE[82]=/g" /DietPi/dietpi/.installed
			sed -i "s/^WEBSERVER_APACHE=/aSOFTWARE_INSTALL_STATE[83]=/g" /DietPi/dietpi/.installed
			sed -i "s/^WEBSERVER_LIGHTTPD=/aSOFTWARE_INSTALL_STATE[84]=/g" /DietPi/dietpi/.installed
			sed -i "s/^WEBSERVER_NGINX=/aSOFTWARE_INSTALL_STATE[85]=/g" /DietPi/dietpi/.installed
			sed -i "s/^WEBSERVER_MYSQL=/aSOFTWARE_INSTALL_STATE[86]=/g" /DietPi/dietpi/.installed
			sed -i "s/^WEBSERVER_SQLITE=/aSOFTWARE_INSTALL_STATE[87]=/g" /DietPi/dietpi/.installed
			sed -i "s/^WEBSERVER_MARIADB=/aSOFTWARE_INSTALL_STATE[88]=/g" /DietPi/dietpi/.installed
			sed -i "s/^WEBSERVER_PHP=/aSOFTWARE_INSTALL_STATE[89]=/g" /DietPi/dietpi/.installed
			sed -i "s/^WEBSERVER_MYADMINPHP=/aSOFTWARE_INSTALL_STATE[90]=/g" /DietPi/dietpi/.installed
			sed -i "s/^WEBSERVER_REDIS=/aSOFTWARE_INSTALL_STATE[91]=/g" /DietPi/dietpi/.installed
			sed -i "s/^LETSENCRYPT=/aSOFTWARE_INSTALL_STATE[92]=/g" /DietPi/dietpi/.installed
			sed -i "s/^PIHOLE=/aSOFTWARE_INSTALL_STATE[93]=/g" /DietPi/dietpi/.installed
			sed -i "s/^FILESERVER_PROFTP=/aSOFTWARE_INSTALL_STATE[94]=/g" /DietPi/dietpi/.installed
			sed -i "s/^FILESERVER_VSFTPD=/aSOFTWARE_INSTALL_STATE[95]=/g" /DietPi/dietpi/.installed
			sed -i "s/^FILESERVER_SAMBA=/aSOFTWARE_INSTALL_STATE[96]=/g" /DietPi/dietpi/.installed
			sed -i "s/^OPENVPNSERVER=/aSOFTWARE_INSTALL_STATE[97]=/g" /DietPi/dietpi/.installed
			sed -i "s/^HAPROXY=/aSOFTWARE_INSTALL_STATE[98]=/g" /DietPi/dietpi/.installed
			sed -i "s/^EMONHUB=/aSOFTWARE_INSTALL_STATE[99]=/g" /DietPi/dietpi/.installed
			sed -i "s/^GRASSHOPPER=/aSOFTWARE_INSTALL_STATE[100]=/g" /DietPi/dietpi/.installed
			sed -i "s/^LOGGING_LOGROTATE=/aSOFTWARE_INSTALL_STATE[101]=/g" /DietPi/dietpi/.installed
			sed -i "s/^LOGGING_RSYSLOG=/aSOFTWARE_INSTALL_STATE[102]=/g" /DietPi/dietpi/.installed
			sed -i "s/^LOGGING_RAMLOG=/aSOFTWARE_INSTALL_STATE[103]=/g" /DietPi/dietpi/.installed
			sed -i "s/^SSHSERVER_DROPBEAR=/aSOFTWARE_INSTALL_STATE[104]=/g" /DietPi/dietpi/.installed
			sed -i "s/^SSHSERVER_OPENSSH=/aSOFTWARE_INSTALL_STATE[105]=/g" /DietPi/dietpi/.installed
			sed -i "s/^RASPCONTROL=/aSOFTWARE_INSTALL_STATE[106]=/g" /DietPi/dietpi/.installed

		fi
		#-------------------------------------------------------------------------------
		#VNC server, set screen :1 as default: https://github.com/Fourdee/DietPi/issues/454#issuecomment-237655998
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'dietpi_vncserver_display=0') )); then

			sed -i '/^dietpi_vncserver_display=/c\dietpi_vncserver_display=1' /DietPi/dietpi.txt

		fi
		#-------------------------------------------------------------------------------
		#Remove bulky header packages on new images 40MB+, located in /usr/src, not required unless native kernel compile.
		if [ ! -f /DietPi/dietpi/.installed ]; then

			apt-get purge -y --force-yes linux-headers*

		fi
		#-------------------------------------------------------------------------------
		#Remove dietpi-uninstall script (moved to dietpi-software)
		rm /DietPi/dietpi/dietpi-uninstall
		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 127 )); then
		#-------------------------------------------------------------------------------
		#Fix mysql key_buffer_size:
		sed -i '/^key_buffer/c\key_buffer_size = 16M' /etc/mysql/my.cnf &> /dev/null
		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 128 )); then
		#-------------------------------------------------------------------------------
		#Zero, set overclock back to default and disable:
		if (( $(cat /DietPi/dietpi/.hw_model | tr '[:upper:]' '[:lower:]' | grep -ci -m1 'rpi zero') )); then

			sed -i '/over_voltage=/c\#over_voltage=0' /DietPi/config.txt
			sed -i '/arm_freq=/c\#arm_freq=1000' /DietPi/config.txt
			sed -i '/core_freq=/c\#core_freq=400' /DietPi/config.txt
			sed -i '/sdram_freq=/c\#sdram_freq=450' /DietPi/config.txt

		fi
		#-------------------------------------------------------------------------------
		#RPi 2/3 - Set correct sdram speed if not active. Used by dietpi-config for reading value.
		if (( $HW_MODEL == 2 || $HW_MODEL == 3 )); then

			sed -i '/^#sdram_freq=/c\#sdram_freq=450' /DietPi/config.txt

		fi
		#-------------------------------------------------------------------------------
		#RPi new installs
		if [ ! -f /DietPi/dietpi/.installed ] && (( $HW_MODEL < 10 )); then

			# - RPi-update backup left on image, remove
			rm -R /boot.bak &> /dev/null

			# - Timezone left on American for v127 img, change back to London
			echo -e "Europe/London" > /etc/timezone
			dpkg-reconfigure -f noninteractive tzdata

		fi

		#-------------------------------------------------------------------------------
		#Only start dietpi-services if system is at final install stage
		if [ -f /DietPi/dietpi/.installed ]; then

			mv /etc/rc.local /etc/rc.local.bak
			whiptail --title "/etc/rc.local updated" --msgbox "/etc/rc.local has been overwritten with an updated version. A backup of your previous rc.local can be found below:\n\n/etc/rc.local.bak" 11 70

		fi

		cat << _EOF_ > /etc/rc.local
#!/bin/bash
if (( \$(cat /DietPi/dietpi/.install_stage) == 1 )); then

    /DietPi/dietpi/dietpi-services start

fi
/DietPi/dietpi/dietpi-banner 0
echo -e " Default Login:\n Username = root\n Password = dietpi\n"
exit 0
_EOF_
		chmod +x /etc/rc.local
		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 129 )); then
		#-------------------------------------------------------------------------------
		#apt-get pref ip version: https://github.com/Fourdee/DietPi/issues/472
		if (( ! $(cat /DietPi/dietpi.txt | grep -ci -m1 '^prefer_ipversion=') )); then

			echo -e "\nprefer_ipversion=auto\n" >> /DietPi/dietpi.txt

		fi
		#-------------------------------------------------------------------------------
		#Removal of dietpi-apt-get_update, revert back to standard apt-get update.
		if [ -f /DietPi/dietpi/dietpi-apt-get_update ]; then #Doesnt exist on v129.5 AmiBerry image, so check exists.

			/DietPi/dietpi/dietpi-apt-get_update 1 #wait for existing job if running.
			rm /DietPi/dietpi/dietpi-apt-get_update

		fi
		#-------------------------------------------------------------------------------
		#Scroll lock fix for RPi by Midwan: https://github.com/Fourdee/DietPi/issues/474#issuecomment-243215674
		if (( $HW_MODEL < 10 )); then

			cat << _EOF_ > /etc/udev/rules.d/50-leds.rules
ACTION=="add", SUBSYSTEM=="leds", ENV{DEVPATH}=="*/input*::scrolllock", ATTR{trigger}="kbd-scrollock"
_EOF_

		fi
		#-------------------------------------------------------------------------------
		#Desktop xcompmgr roll out. Patch existing systems and reinstall xserver.

		# - remove LXDE xcomp line for c1/c2 on LXDE autostart conf
		sed -i '/^xcompmgr/d' /etc/xdg/lxsession/LXDE/autostart &> /dev/null

		# - New function, will only reinstall if the program is currently installed.
		/DietPi/dietpi/dietpi-software reinstall 6
		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 130 )); then
		#-------------------------------------------------------------------------------
		#C2 v130 image: apt-get update prior to this script has no effect. No apt-cache: https://github.com/Fourdee/DietPi/issues/508#issuecomment-246196842
		#NB: Regardless, run for all devices.
		apt-get update

		#C2: apt-get upgrade 'uboot' package update without 'linux-image' at the same time = failed boot.
		#NB: Apply to odroids as we also hold kernel packages for XU4.
		if (( $HW_MODEL >= 10 && $HW_MODEL < 20 )); then


			apt-mark unhold linux-*
			DEBIAN_FRONTEND='noninteractive' apt-get dist-upgrade --force-yes -y

		fi
		#-------------------------------------------------------------------------------
		#Auto mount USB drive by default https://github.com/Fourdee/DietPi/issues/501
		# - All excluding VM images
		if (( $HW_MODEL != 20 )); then

			cp /etc/fstab /etc/fstab.v130

			# - Remove old FStab entries
			sed -i '/\/dev\/sd[a-z]1[[:space:]]/d' /etc/fstab
			sed -i '/\/mnt\/usb_[0-9][[:space:]]/d' /etc/fstab

			sed -i '/^#External Drives-/d' /etc/fstab
			sed -i '/^# - Try and use only ext4 for USB drives/d' /etc/fstab
			sed -i '/^# - Faster performance than NTFS, espically on RPi v1/d' /etc/fstab
			sed -i '/^#NB: Please use dietpi-drive_manager/d' /etc/fstab

			# - Add new automount entries that supports all FS types
			cat << _EOF_ >> /etc/fstab

#External Drives---------------------------------------------------
#NB: Please use dietpi-drive_manager to setup and control your external drives.
/dev/sda1       /mnt/usb_1      auto     defaults,noatime,nofail,x-systemd.automount  0       0
#/dev/sdb1       /mnt/usb_2      auto     defaults,noatime,nofail,x-systemd.automount  0       0
#/dev/sdc1       /mnt/usb_3      auto     defaults,noatime,nofail,x-systemd.automount  0       0
#/dev/sdd1       /mnt/usb_4      auto     defaults,noatime,nofail,x-systemd.automount  0       0
#/dev/sde1       /mnt/usb_5      auto     defaults,noatime,nofail,x-systemd.automount  0       0
_EOF_

			systemctl daemon-reload

		fi
		#-------------------------------------------------------------------------------
		#add HFS+ FS support for all DietPi systems by default: https://github.com/Fourdee/DietPi/issues/271#issuecomment-245651818
		apt-get install -y hfsplus #hfsprogs is for format capabilities
		#-------------------------------------------------------------------------------
		#NFS: https://github.com/Fourdee/DietPi/issues/246
		mkdir -p /mnt/nfs_client
		echo -e "NFS client can be installed and setup by DietPi-Config.\nSimply run: dietpi-config and select the Networking Options: NAS/Misc menu" > /mnt/nfs_client/readme.txt

		# - fstab template entry
		if (( ! $(cat /etc/fstab | grep -ci -m1 '/mnt/nfs_client') )); then

			echo -e "\n#NFS Client Mount--------------------------------------------------\n#/mnt/nfs_client . Please use dietpi-config and the Networking Options: NAS menu to setup this mount" >> /etc/fstab

		fi

		# - dietpi.txt entries
		if (( ! $(cat /DietPi/dietpi.txt | grep -ci -m1 '^nfsclient_ipaddress=') )); then

			echo -e "\nnfsclient_ipaddress=" >> /DietPi/dietpi.txt

		fi
		#-------------------------------------------------------------------------------
		#DietPi-Drive_Manager
		# - remove old program
		rm /DietPi/dietpi/dietpi-external_drive_setup
		# - setup alias
		if (( ! $(cat /etc/bash.bashrc | grep -ci -m1 'dietpi-drive_manager=') )); then

			sed -i "/#DietPi Additions/a alias dietpi-drive_manager='/DietPi/dietpi/dietpi-drive_manager'" /etc/bash.bashrc

		fi
		#-------------------------------------------------------------------------------
		#New rc.local : boottime
		if [ -f /DietPi/dietpi/.installed ]; then

			mv /etc/rc.local /etc/rc.local.bak
			whiptail --title "/etc/rc.local updated" --msgbox "/etc/rc.local has been overwritten with an updated version. A backup of your previous rc.local can be found below:\n\n/etc/rc.local.bak" 11 70

		fi

		cat << _EOF_ > /etc/rc.local
#!/bin/bash
echo -e "\$(cat /proc/uptime | awk '{print \$1}') Seconds" > /var/log/boottime
if (( \$(cat /DietPi/dietpi/.install_stage) == 1 )); then

    /DietPi/dietpi/dietpi-services start

fi
/DietPi/dietpi/dietpi-banner 0
echo -e " Default Login:\n Username = root\n Password = dietpi\n"
exit 0
_EOF_
		chmod +x /etc/rc.local
		#-------------------------------------------------------------------------------
		#AmiBerry v2 binary update
		/DietPi/dietpi/dietpi-software reinstall 108
		#-------------------------------------------------------------------------------
		#ifmetric: https://github.com/Fourdee/DietPi/issues/515
		apt-get purge ifmetric -y
		sed -i '/^metric /d' /etc/network/interfaces
		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 131 )); then
		#-------------------------------------------------------------------------------
		#Install p7zip by default on all DietPi systems
		apt-get install -y p7zip-full
		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 132 )); then
		#-------------------------------------------------------------------------------
		#Interactive CPU gov by default:
		CPU_GOVERNOR_CURRENT=$(cat /DietPi/dietpi.txt | grep -m1 '^cpu_governor=' | sed 's/.*=//')
		if [ "$CPU_GOVERNOR_CURRENT" = "ondemand" ]; then

			sed -i "/^cpu_governor=/c\cpu_governor=interactive" /DietPi/dietpi.txt
			/DietPi/dietpi/dietpi-cpu_set

		fi
		#-------------------------------------------------------------------------------
		#dietpi.txt entries : https://github.com/Fourdee/DietPi/issues/533
		if (( ! $(cat /DietPi/dietpi.txt | grep -ci -m1 '^AUTO_Global_Password=') )); then

			echo -e "\nAUTO_Global_Password=dietpi\n" >> /DietPi/dietpi.txt

		fi
		if (( ! $(cat /DietPi/dietpi.txt | grep -ci -m1 '^Apt_Raspbian_Mirror=') )); then

			echo -e "\nApt_Raspbian_Mirror=http://mirror.ox.ac.uk/sites/archive.raspbian.org/archive/raspbian\n" >> /DietPi/dietpi.txt

		fi
		if (( ! $(cat /DietPi/dietpi.txt | grep -ci -m1 '^Apt_Debian_Mirror=') )); then

			echo -e "\nApt_Debian_Mirror=http://ftp.debian.org/debian\n" >> /DietPi/dietpi.txt

		fi
		if (( ! $(cat /DietPi/dietpi.txt | grep -ci -m1 '^AUTO_Dedicated_Usb_Drive_Format_Filesystem=') )); then

			echo -e "\nAUTO_Dedicated_Usb_Drive_Format_Filesystem=0\n" >> /DietPi/dietpi.txt

		fi
		if (( ! $(cat /DietPi/dietpi.txt | grep -ci -m1 '^dietpi_nextcloud_username=') )); then

			echo -e "\ndietpi_nextcloud_username=admin\n" >> /DietPi/dietpi.txt

		fi
		#-------------------------------------------------------------------------------
		#FriendlyARM images, remove custom services:
		if (( $HW_MODEL == 61 || $HW_MODEL == 62 )); then

			rm /lib/systemd/system/lcd4linux.service
			rm /lib/systemd/system/hwservice.service
			rm /lib/systemd/system/hwservice_monitor.service
			systemctl daemon-reload

		fi
		#-------------------------------------------------------------------------------
		#ethtool:
		apt-get install -y ethtool
		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 133 )); then
		#-------------------------------------------------------------------------------
		#NanoPi T2 bluetooth + patch by AWL29: http://dietpi.com/phpbb/viewtopic.php?f=12&t=622&start=40#p3280
		if (( $HW_MODEL == 61 )); then

			BT_USER_ENABLED=0
			if (( $(lsmod | grep -ci -m1 '^bluetooth') )); then

				BT_USER_ENABLED=1

			fi

			wget http://dietpi.com/downloads/binaries/all/ap6212_bt_patch.7z -O package.7z
			7z x -y package.7z -o/

			chmod +x /bin/brcm_patchram_plus
			chmod +x /bin/bumpRTSCTS
			chmod +x /etc/init.d/brcm_patchram_plus
			chmod +x /lib/systemd/system/brcm_patchram_plus.service

			# - BT modules must be enabled before installation. Else, apt-get install will fail on bluetooth package init.
			/DietPi/dietpi/func/dietpi-set_hardware bluetooth enable # will fail on bluetooth service start. Expected, as not installed yet.
			/DietPi/dietpi/func/dietpi-notify 2 "If the above returns an error, it can safely be ignored as BT isnt installed yet."

			apt-get install bluetooth -y

			# - Disable BT modules, if the user had it disabled before hand:
			if (( ! $BT_USER_ENABLED )); then

				/DietPi/dietpi/func/dietpi-notify 2 "BT was in a disabled state previously, setting back to disabled."
				/DietPi/dietpi/func/dietpi-set_hardware bluetooth disable

			fi

		fi
		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 134 )); then
		#-------------------------------------------------------------------------------
		#DietPi services updated to SystemD:

		# - Stop and remove old service
		#/DietPi/dietpi/dietpi-services stop # not required, ran from dietpi-update script before hand
		systemctl stop dietpi-service

		systemctl disable dietpi-service
		update-rc.d dietpi-service remove
		rm /etc/init.d/dietpi-service

		# - Install new services
		cat << _EOF_ > /etc/systemd/system/dietpi-ramdisk.service
[Unit]
Description=DietPi-RAMdisk

[Service]
Type=forking
RemainAfterExit=yes
ExecStart=/bin/bash -c '/boot/dietpi/dietpi-ramdisk 0'
ExecStop=/bin/bash -c '/DietPi/dietpi/dietpi-ramdisk 1'

[Install]
WantedBy=local-fs.target
_EOF_
		systemctl enable dietpi-ramdisk.service
		systemctl daemon-reload
		systemctl start dietpi-ramdisk.service

		#	DietPi-Ramlog
cat << _EOF_ > /etc/systemd/system/dietpi-ramlog.service
[Unit]
Description=DietPi-RAMlog
Before=rsyslog.service syslog.service

[Service]
Type=forking
RemainAfterExit=yes
ExecStart=/bin/bash -c '/boot/dietpi/dietpi-ramlog 0'
ExecStop=/bin/bash -c '/DietPi/dietpi/dietpi-ramlog 1'

[Install]
WantedBy=local-fs.target
_EOF_
		systemctl enable dietpi-ramlog.service
		systemctl daemon-reload
		systemctl start dietpi-ramlog.service

		#	Boot
		cat << _EOF_ > /etc/systemd/system/dietpi-boot.service
[Unit]
Description=DietPi-Boot
After=network-online.target network.target networking.service dietpi-ramdisk.service dietpi-ramlog.service
Requires=dietpi-ramdisk.service

[Service]
Type=oneshot
RemainAfterExit=yes
ExecStart=/bin/bash -c '/DietPi/dietpi/boot'
StandardOutput=tty

[Install]
WantedBy=multi-user.target
_EOF_
		systemctl enable dietpi-boot.service

		cat << _EOF_ > /etc/systemd/system/rc-local.service
[Unit]
Description=/etc/rc.local Compatibility
After=dietpi-boot.service dietpi-ramdisk.service dietpi-ramlog.service
Requires=dietpi-boot.service dietpi-ramdisk.service

[Service]
Type=idle
ExecStart=/etc/rc.local
StandardOutput=tty
RemainAfterExit=yes

[Install]
WantedBy=multi-user.target
_EOF_
		systemctl enable rc-local.service

		if [ -f /DietPi/dietpi/.installed ]; then

			mv /etc/rc.local /etc/rc.local.bak
			whiptail --title "/etc/rc.local updated" --msgbox "/etc/rc.local has been overwritten with an updated version. A backup of your previous rc.local can be found below:\n\n/etc/rc.local.bak" 11 70

		fi

		cat << _EOF_ > /etc/rc.local
#!/bin/bash
#Precaution: Wait for DietPi Ramdisk to finish
while [ ! -f /DietPi/.ramdisk ]
do

    /DietPi/dietpi/func/dietpi-notify 2 "Waiting for DietPi-RAMDISK to finish mounting DietPi to RAM..."
    sleep 1

done

echo -e "\$(cat /proc/uptime | awk '{print \$1}') Seconds" > /var/log/boottime
if (( \$(cat /DietPi/dietpi/.install_stage) == 1 )); then

    /DietPi/dietpi/dietpi-services start

fi
/DietPi/dietpi/dietpi-banner 0
echo -e " Default Login:\n Username = root\n Password = dietpi\n"
exit 0
_EOF_
		chmod +x /etc/rc.local
		systemctl daemon-reload
		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 135 )); then
		#-------------------------------------------------------------------------------
		#Soundcard fixes & changes, requires a reapply to overwrite and patch existing settings.
		#	JustBoom, pattern match as end of string may contain '-noeq' due to: https://github.com/Fourdee/DietPi/issues/585
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 '^soundcard=justboom-dac') )); then

			/DietPi/dietpi/func/dietpi-set_hardware soundcard justboom-dac-eq

		elif (( $(cat /DietPi/dietpi.txt | grep -ci -m1 '^soundcard=justboom-digi') )); then

			/DietPi/dietpi/func/dietpi-set_hardware soundcard justboom-digi-eq

		# - Reapply active card
		else

			/DietPi/dietpi/func/dietpi-set_hardware soundcard $(cat /DietPi/dietpi.txt | grep -m1 'soundcard=' | sed 's/.*=//')

		fi

		#Reinstall ALSA to enable bash alias for dietpi-justboom on all soundcards.
		#Reinstall HiFi to update YMPD clients to latest version.
		/DietPi/dietpi/dietpi-software reinstall 5 32

		#-------------------------------------------------------------------------------
		#Force use of existing installed configs if available, else install new. Also disables end user prompt from dpkg
		cat << _EOF_ > /etc/apt/apt.conf.d/local
Dpkg::Options {
   "--force-confdef";
   "--force-confold";
}
_EOF_

		#-------------------------------------------------------------------------------
		#NoIP2 systemd service patch: https://github.com/Fourdee/DietPi/issues/589
		if [ -f /etc/init.d/noip2 ]; then

			update-rc.d noip2 remove
			rm /etc/init.d/noip2
			cat << _EOF_ > /etc/systemd/system/noip2.service
[Unit]
Description=noip2
After=network.target network-online.target rsyslog.service

[Service]
Type=forking
RemainAfterExit=yes

ExecStart=/usr/local/bin/noip2
ExecStop=/usr/bin/killall -w noip2

[Install]
WantedBy=multi-user.target
_EOF_
			systemctl daemon-reload

		fi
		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 136 )); then
		#-------------------------------------------------------------------------------
		#Reinstalls
		# - MySQL: Apply optimizations for reduced memory usage: https://github.com/Fourdee/DietPi/issues/605
		# - DietPi-Cloudshell: Reinstall to apply new service for tty1 use
		# - vnc servers: Reinstall to allow use of new shared desktop mode
		/DietPi/dietpi/dietpi-software reinstall 86 62 27 28

		# - requires new save file
		if [ -f /DietPi/dietpi/.dietpi-cloudshell ]; then

			whiptail --title "DietPi-Cloudshell Upgrade" --msgbox "DietPi-Cloudshell has been updated to the latest version. This version has significant changes to the settings/savefile system, which requires your current settings to be reset.\n\nYour previous settings have been cleared. Please run dietpi-cloudshell to reconfigure as needed." 12 70
			rm /DietPi/dietpi/.dietpi-cloudshell

		fi

		#Add roon to dietpi-process_tool: http://dietpi.com/phpbb/viewtopic.php?f=9&t=826#p3711

		#-------------------------------------------------------------------------------
		#Shared VNC server options: https://github.com/Fourdee/DietPi/issues/607
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'dietpi_vncserver_shared_desktop=') )); then

			echo -e "\ndietpi_vncserver_shared_desktop=0" >> /DietPi/dietpi.txt

		fi
		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 137 )); then
		#-------------------------------------------------------------------------------
		#Updated desktop icons: https://github.com/Fourdee/DietPi/issues/616

		# - Desktop confs are now located online, so remove from DietPi-Ramdisk to save some memory.
		rm -R /DietPi/dietpi/conf/desktop

		if [ -f /DietPi/dietpi/.installed ]; then

			#23 24 25 26
			if (( $(cat /DietPi/dietpi/.installed | grep -ci -m1 '^aSOFTWARE_INSTALL_STATE\[23\]=2') ||
				$(cat /DietPi/dietpi/.installed | grep -ci -m1 '^aSOFTWARE_INSTALL_STATE\[24\]=2') ||
				$(cat /DietPi/dietpi/.installed | grep -ci -m1 '^aSOFTWARE_INSTALL_STATE\[25\]=2') ||
				$(cat /DietPi/dietpi/.installed | grep -ci -m1 '^aSOFTWARE_INSTALL_STATE\[26\]=2') )); then

				# - Remove old symlinks
				rm /usr/share/applications/dietpi-*
				rm "$HOME"/Desktop/dietpi-*

				# - reinstall new
				mkdir -p /usr/share/applications
				wget http://dietpi.com/downloads/conf/desktop/dietpi-software.desktop -O /usr/share/applications/dietpi-software.desktop
				wget http://dietpi.com/downloads/conf/desktop/dietpi-update.desktop -O /usr/share/applications/dietpi-update.desktop
				wget http://dietpi.com/downloads/conf/desktop/dietpi-config.desktop -O /usr/share/applications/dietpi-config.desktop
				wget http://dietpi.com/downloads/conf/desktop/dietpi-uninstall.desktop -O /usr/share/applications/dietpi-uninstall.desktop
				wget http://dietpi.com/downloads/conf/desktop/dietpi-backup.desktop -O /usr/share/applications/dietpi-backup.desktop
				wget http://dietpi.com/downloads/conf/desktop/dietpi-sync.desktop -O /usr/share/applications/dietpi-sync.desktop
				wget http://dietpi.com/downloads/conf/desktop/dietpi-bugreport.desktop -O /usr/share/applications/dietpi-bugreport.desktop
				wget http://dietpi.com/downloads/conf/desktop/dietpi-process_tool.desktop -O /usr/share/applications/dietpi-process_tool.desktop
				wget http://dietpi.com/downloads/conf/desktop/dietpi-cleaner.desktop -O /usr/share/applications/dietpi-cleaner.desktop
				wget http://dietpi.com/downloads/conf/desktop/dietpi-cron.desktop -O /usr/share/applications/dietpi-cron.desktop
				wget http://dietpi.com/downloads/conf/desktop/dietpi-launcher.desktop -O /usr/share/applications/dietpi-launcher.desktop
				wget http://dietpi.com/downloads/conf/desktop/dietpi-justboom.desktop -O /usr/share/applications/dietpi-justboom.desktop

				#DietPi Desktop symlinks
				ln -sf /usr/share/applications/dietpi-software.desktop "$HOME"/Desktop/dietpi-software.desktop
				ln -sf /usr/share/applications/dietpi-config.desktop "$HOME"/Desktop/dietpi-config.desktop
				ln -sf /usr/share/applications/dietpi-launcher.desktop "$HOME"/Desktop/dietpi-launcher.desktop

				#Download icons
				mkdir -p /etc/dietpi/desktop_icons
				wget http://dietpi.com/downloads/conf/desktop/dietpi-icon.png -O /etc/dietpi/desktop_icons/dietpi-icon.png
				wget http://dietpi.com/downloads/conf/desktop/grey_16x16.png -O /etc/dietpi/desktop_icons/grey_16x16.png
				wget http://dietpi.com/downloads/conf/desktop/kodi-icon.png -O /etc/dietpi/desktop_icons/kodi-icon.png
				wget http://dietpi.com/downloads/conf/desktop/justboom.png -O /etc/dietpi/desktop_icons/justboom.png

				#Kodi
				if (( $(cat /DietPi/dietpi/.installed | grep -ci -m1 '^aSOFTWARE_INSTALL_STATE\[31\]=2') )); then

					rm /usr/share/applications/kodi.desktop
					wget http://dietpi.com/downloads/conf/desktop/kodi.desktop -O /usr/share/applications/kodi.desktop
					ln -sf /usr/share/applications/kodi.desktop "$HOME"/Desktop/kodi.desktop

				fi

				# - Set execute to prevent "untrusted" prompt in Mate, and possibily other desktops.
				chmod +x /usr/share/applications/*

			fi

		fi
		#-------------------------------------------------------------------------------
		#Reinstalls:
		#	C2: FBTURBO provides much better desktop performance over Mali DDX: http://forum.odroid.com/viewtopic.php?f=138&t=19948&p=169808#p169808
		#	Squeezelite 1.8 update to enable -C flag: https://github.com/Fourdee/DietPi/issues/620
		/DietPi/dietpi/dietpi-software reinstall 6 36
		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 138 )); then
		#-------------------------------------------------------------------------------
		#nanoPi M3 image cleanup (some things we missed), but lets apply to all devices on fresh install:
		if [ ! -f /DietPi/dietpi/.installed ]; then

			userdel -f fa
			apt-get purge -y modemmanager hostapd libgoa-* libfm-*

			# - May as well remove unneeded RPi packages while we are here: https://github.com/Fourdee/DietPi/issues/598
			apt-get purge -y libboost-iostreams1.49.0 libboost-iostreams1.50.0 libboost-iostreams1.53.0 libboost-iostreams1.54.0 gcc-4.6-base gcc-4.7-base gcc-4.8-base libsigc++-1.2-5c2

			apt-get autoremove -y --purge

		fi
		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 139 )); then
		#-------------------------------------------------------------------------------
		echo 0
		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 140 )); then
		#-------------------------------------------------------------------------------
		#C2 libc6 u7 breaking most installations, replace with u6: https://github.com/Fourdee/DietPi/issues/653
		#	https://github.com/Fourdee/DietPi/issues/663#issuecomment-269867184
		if (( $HW_MODEL == 12 )); then

			wget http://ftp.us.debian.org/debian/pool/main/g/glibc/libc6_2.19-18+deb8u6_arm64.deb -O package.deb
			dpkg -i package.deb
			rm package.deb

			# - Just incase u6 is outdated by the time this patch is run, lets also update and upgrade apt:
			apt-get update
			AGU

		fi
		#-------------------------------------------------------------------------------
		#Stretch, disable automatic updates and management of apt cache. Prevents unexpected lock on Apt cache and therefore failed apt installations.
		#	Very similar to a system DietPi had a while back that background threaded weekly apt-get updates, was removed as repo files change and without apt-get update prior to install, chance of package no longer existing (eg: package-1.2.3 changes to package-1.2.4), unless the apt list was also updated.
		if (( $DISTRO == 4 )); then

			systemctl mask apt-daily.service

		fi
		#-------------------------------------------------------------------------------
		#Apt-transport install by default on all systems:
		apt-get install -y apt-transport-https
		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 141 )); then
		#-------------------------------------------------------------------------------
		#DietPi-Backup settings file has been recoded, must be generated again
		if [ -f /DietPi/dietpi/.dietpi-backup_settings ]; then

			mv /DietPi/dietpi/.dietpi-backup_settings /DietPi/dietpi/.dietpi-backup_settings_v141

			# - Inform user
			whiptail --title "DietPi-Backup Changes:" --msgbox "Significant changes have been made to DietPi-Backup in v142. Due to this, existing backups, made with DietPi v141 or lower are no longer compatible.\nPlease see the url below for more information, and a method to restore a previous backup from DietPi v141 and lower:\n\nhttps://github.com/Fourdee/DietPi/issues/685#issuecomment-270145794" 15 75

		fi
		#-------------------------------------------------------------------------------
		#Disable auto mounting of usb_1, if not in use: https://github.com/Fourdee/DietPi/issues/684
		if (( ! $(df -P | grep -ci -m1 '/mnt/usb_1') )); then

			sed -i '/\/mnt\/usb_1/c\#\/dev\/sda1       \/mnt\/usb_1      auto     defaults,noatime,nofail,x-systemd.automount  0 0' /etc/fstab
			systemctl daemon-reload

		fi
		#-------------------------------------------------------------------------------
		#RPi 3 Bluetooth packages missing: https://github.com/Fourdee/DietPi/issues/693
		if (( $HW_MODEL < 10 )); then

			apt-get install -y pi-bluetooth --reinstall

			# - Check if previously disabled, and reapply
			if [ -f /etc/modprobe.d/disable_bt.conf ]; then

				/DietPi/dietpi/func/dietpi-set_hardware bluetooth disable

			fi

		fi
		#-------------------------------------------------------------------------------
		#Stretch RPi WiFi fix + firmware: https://github.com/Fourdee/DietPi/issues/475#issuecomment-270696515
		if (( $DISTRO == 4 && $HW_MODEL < 10 )); then

			AGDU
			wget https://raw.githubusercontent.com/RPi-Distro/firmware-nonfree/master/brcm80211/brcm/brcmfmac43430-sdio.txt -O /lib/firmware/brcm/brcmfmac43430-sdio.txt

		fi
		#-------------------------------------------------------------------------------
		#Sparky SBC fixes:
		#	Additional blacklist to disable touch screen, and dmesg errors associated with it: https://github.com/Fourdee/DietPi/issues/699#issuecomment-271362441
		if (( $HW_MODEL == 70 )); then

			cat << _EOF_ > /etc/modprobe.d/disable_sparkysbc_touchscreen.conf
blacklist ctp_gsl3680
_EOF_

		fi
		#-------------------------------------------------------------------------------
		#Alsamixer fix, reapply current soundcard with updated asound.conf: https://github.com/Fourdee/DietPi/issues/705
		if [ -f /DietPi/dietpi/.installed ]; then

			/DietPi/dietpi/func/dietpi-set_hardware soundcard $(cat /DietPi/dietpi.txt | grep -m1 'soundcard=' | sed 's/.*=//')

		fi
		#-------------------------------------------------------------------------------
		#RPi, install common rpi specific binaries by default (eg: raspistill)
		if (( $HW_MODEL < 10 )); then

			apt-get install -y --reinstall --force-yes libraspberrypi-bin

		fi
		#-------------------------------------------------------------------------------
		#Reinstalls:
		#	DietPi Cam: https://github.com/Fourdee/DietPi/issues/706
		#	NetData 1.4
		#	Move MySQL + MariaDB store to DietPi User data location:
		/DietPi/dietpi/dietpi-software reinstall 59 65 86 88
		#-------------------------------------------------------------------------------
		#switch from NTPD to systemd-timesyncd for drift mode (4): https://github.com/Fourdee/DietPi/issues/709
		if (( $(cat /DietPi/dietpi.txt | grep -m1 '^ntpd_update_mode=' | sed 's/.*=//') == 4 )); then

			timedatectl set-ntp true

		fi
		#-------------------------------------------------------------------------------
		#Inform our Allo Piano 2 users of updated sound card:
		if [ -f /DietPi/dietpi/.installed ] &&
			(( $(cat /DietPi/dietpi.txt | grep 'soundcard=' | grep -ci -m1 'allo-piano') )); then

			whiptail --title "Allo Piano 2.1" --msgbox "The driver for the Allo Piano 2.1 DAC has been updated. \n\nIf you are using a Allo Piano DAC 2.1, please reselect this sound card from dietpi-config, to apply the updated driver." 12 70

		fi
		#-------------------------------------------------------------------------------
		#Remove Meveric's CPU governor scripts, all Odroid images
		if (( $HW_MODEL >= 10 && $HW_MODEL < 20 )); then

			systemctl disable cpu_governor &> /dev/null
			rm /etc/init.d/cpu_governor &> /dev/null
			rm /etc/systemd/system/cpu_governor.service &> /dev/null
			systemctl daemon-reload

		fi
		#-------------------------------------------------------------------------------
		#Reduce DHCP request retry count and timeouts: https://github.com/Fourdee/DietPi/issues/711
		sed -i '/^#timeout /d' /etc/dhcp/dhclient.conf
		sed -i '/^#retry /d' /etc/dhcp/dhclient.conf
		sed -i '/^timeout /d' /etc/dhcp/dhclient.conf
		sed -i '/^retry /d' /etc/dhcp/dhclient.conf
		cat << _EOF_ >> /etc/dhcp/dhclient.conf
timeout 10;
retry 4;
_EOF_

		#-------------------------------------------------------------------------------
		#systemctl disable armhwinfo: Turns out this does more than just obtain info, also sets device specific "workarounds/fixes": https://github.com/igorpecovnik/lib/blob/73a4dd60a2b6ab9bd8008fb0ef06344e378a557f/scripts/armhwinfo
		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 142 )); then
		#-------------------------------------------------------------------------------
		#OPi Zero (apply to all) | ARMbian, disable 1st run script:
		systemctl disable firstrun &> /dev/null
		rm /etc/init.d/firstrun &> /dev/null
		#-------------------------------------------------------------------------------
		#Pine A64, fb cursor: https://github.com/Fourdee/DietPi/issues/596#issuecomment-274328262
		if (( $HW_MODEL >= 40 && $HW_MODEL <= 42 )); then

			cat << _EOF_ >> "$HOME"/.bashrc
infocmp > terminfo.txt
sed -i -e 's/?0c/?112c/g' -e 's/?8c/?48;0;64c/g' terminfo.txt
tic terminfo.txt
tput cnorm
_EOF_

		fi
		#-------------------------------------------------------------------------------
		#Reinstalls:
		#	Netdata 1.5.0: https://github.com/Fourdee/DietPi/issues/728
		/DietPi/dietpi/dietpi-software reinstall 65
		#
		#-------------------------------------------------------------------------------
		#DietPi-Ramdisk:
		# - add debugging: https://github.com/Fourdee/DietPi/issues/719
		# - after local-fs.target
		#	DietPi-Ramdisk
		cat << _EOF_ > /etc/systemd/system/dietpi-ramdisk.service
[Unit]
Description=DietPi-RAMdisk
After=local-fs.target

[Service]
Type=forking
RemainAfterExit=yes
ExecStartPre=/bin/mkdir -p /etc/dietpi/logs
ExecStart=/bin/bash -c '/boot/dietpi/dietpi-ramdisk 0 &>> /etc/dietpi/logs/dietpi-ramdisk.log'
ExecStop=/bin/bash -c '/DietPi/dietpi/dietpi-ramdisk 1 &>> /etc/dietpi/logs/dietpi-ramdisk.log'

[Install]
WantedBy=local-fs.target
_EOF_

		#	DietPi-Ramlog
		cat << _EOF_ > /etc/systemd/system/dietpi-ramlog.service
[Unit]
Description=DietPi-RAMlog
Before=rsyslog.service syslog.service
After=local-fs.target

[Service]
Type=forking
RemainAfterExit=yes
ExecStart=/bin/bash -c '/boot/dietpi/dietpi-ramlog 0'
ExecStop=/bin/bash -c '/DietPi/dietpi/dietpi-ramlog 1'

[Install]
WantedBy=local-fs.target
_EOF_
		systemctl daemon-reload

		# - Restart RAMdisk now
		systemctl restart dietpi-ramdisk.service
		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 143 )); then
		#-------------------------------------------------------------------------------
		#Samba clients, remove _netdev: https://github.com/Fourdee/DietPi/issues/744
		if (( ! $(cat /etc/fstab | grep -ci -m1 '^#/mnt/samba') )); then

			/DietPi/dietpi/func/dietpi-set_smbclient 1

		fi
		#-------------------------------------------------------------------------------
		#Sparky SBC kernel upgrade from Allo, improve USB DAC support:
		if (( $HW_MODEL == 70 )); then

			/DietPi/dietpi/func/dietpi-set_hardware kernel sparky_sbc

		fi
		#-------------------------------------------------------------------------------
		#Reinstalls
		#	RoonBridge 1.3 update: https://github.com/Fourdee/DietPi/issues/749
		#	AmiBerry 2.1: https://github.com/Fourdee/DietPi/issues/756
		/DietPi/dietpi/dietpi-software reinstall 108 121
		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 144 )); then
		#-------------------------------------------------------------------------------
		#Use our new EU mirror for mdrjr repo (Meveric's packages):
		if (( $HW_MODEL >= 10 && $HW_MODEL < 20 )); then

			sed -i 's@http://oph.mdrjr.net/meveric@http://fuzon.co.uk/meveric@' /etc/apt/sources.list.d/*

		fi
		#-------------------------------------------------------------------------------
		#New installs, remove /mnt/usb_x entries in /etc/fstab and /mnt
		if [ ! -f /DietPi/dietpi/.installed ]; then

			rm -R /mnt/usb_1
			sed -i "\@[[:space:]]/mnt/usb_[1-9][[:space:]]@d" /etc/fstab

		fi
		#-------------------------------------------------------------------------------
		#Disable ARMbian's log2ram: https://github.com/Fourdee/DietPi/issues/781
		systemctl disable log2ram.service
		rm /usr/local/sbin/log2ram &> /dev/null
		rm /etc/systemd/system/log2ram.service &> /dev/null
		#-------------------------------------------------------------------------------
		#Cleanup ARMbian's resize service (not automatically removed by ARMbian scripts...)
		systemctl disable resize2fs &> /dev/null
		rm /etc/systemd/system/resize2fs.service &> /dev/null
		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 145 )); then
		#-------------------------------------------------------------------------------
		#/usr/bin/sudo: https://github.com/Fourdee/DietPi/issues/794
		chmod 4755 /usr/bin/sudo
		#-------------------------------------------------------------------------------
		#NTPD: Update DietPi Cron jobs: https://github.com/Fourdee/DietPi/issues/786
		cp /DietPi/dietpi/conf/cron.daily_dietpi /etc/cron.daily/dietpi
		chmod +x /etc/cron.daily/dietpi
		cp /DietPi/dietpi/conf/cron.hourly_dietpi /etc/cron.hourly/dietpi
		chmod +x /etc/cron.hourly/dietpi
		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 146 )); then
		#-------------------------------------------------------------------------------
		#Shairport sync 3.0.2: https://github.com/Fourdee/DietPi/issues/819
		#MPD 19.21: https://github.com/Fourdee/DietPi/issues/821
		#NetData 1.6: https://github.com/Fourdee/DietPi/issues/832
		#Chromium: https://github.com/Fourdee/DietPi/issues/835
		/DietPi/dietpi/dietpi-software reinstall 37 65 113 128
		#-------------------------------------------------------------------------------
		#New installs: pump default locale into sys env: https://github.com/Fourdee/DietPi/issues/825
		if [ ! -f /DietPi/dietpi/.installed ]; then

			cat << _EOF_ > /etc/environment
LC_ALL=en_GB.UTF-8
LANG=en_GB.UTF-8
_EOF_

		fi
		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 147 )); then
		#-------------------------------------------------------------------------------
		#Apply WiFi country code to cfg80211 mod params, aswell as 'iw reg set' (currently): https://github.com/Fourdee/DietPi/issues/838
		echo -e "options cfg80211 ieee80211_regdom=$(cat /DietPi/dietpi.txt | grep -m1 '^wifi_country_code=' | sed 's/.*=//')" > /etc/modprobe.d/cfg80211.conf
		#-------------------------------------------------------------------------------
		#Delay boot until network is established: 0=disabled | 1=10 second wait max (default) | 2=infinite wait: https://github.com/Fourdee/DietPi/issues/842
		if (( ! $(cat /DietPi/dietpi.txt | grep -ci -m1 '^boot_wait_for_network=') )); then

			echo -e "\nboot_wait_for_network=1\n" >> /DietPi/dietpi.txt

		fi
		#-------------------------------------------------------------------------------
		#update cron jobs, removal of old df code for TRIM
		cp /DietPi/dietpi/conf/cron.daily_dietpi /etc/cron.daily/dietpi
		chmod +x /etc/cron.daily/dietpi
		cp /DietPi/dietpi/conf/cron.hourly_dietpi /etc/cron.hourly/dietpi
		chmod +x /etc/cron.hourly/dietpi
		#-------------------------------------------------------------------------------
		#ARMbian log2ram cron job cleanup: http://dietpi.com/phpbb/viewtopic.php?f=11&t=1580&p=6478#p6478
		rm /etc/cron.hourly/log2ram &> /dev/null
		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 148 )); then
		#-------------------------------------------------------------------------------
		#Sudo UID bit (was missing from finalize script): https://github.com/Fourdee/DietPi/issues/794
		chmod 4755 /usr/bin/sudo
		#-------------------------------------------------------------------------------
		#Create DietPi user: https://github.com/Fourdee/DietPi/issues/796
		/DietPi/dietpi/func/dietpi-set_software	useradd_dietpi 1
		#-------------------------------------------------------------------------------
		#DietPi-Config + display rotation options: https://github.com/Fourdee/DietPi/issues/859
		if (( $HW_MODEL < 10 )); then

			if (( ! $(cat /DietPi/config.txt | grep -ci -m1 'display_rotate=') )); then

				echo -e "\ndisplay_rotate=0" >> /DietPi/config.txt

			fi

			if (( ! $(cat /DietPi/config.txt | grep -ci -m1 'lcd_rotate=') )); then

				echo -e "\nlcd_rotate=0" >> /DietPi/config.txt

			fi

		fi
		#-------------------------------------------------------------------------------
		#+ARMbian increase console verbose
		sed -i '/verbosity=/c\verbosity=7' /boot/armbianEnv.txt &> /dev/null
		#-------------------------------------------------------------------------------
		#AmiBerry name change: https://github.com/Fourdee/DietPi/issues/850
		if [ -f /DietPi/dietpi/.installed ] &&
			(( $(cat /DietPi/dietpi/.installed | grep -ci -m1 '^aSOFTWARE_INSTALL_STATE\[108\]=2') )); then

			killall -w uae4arm-rpi

			mv /etc/uae4arm-rpi /etc/amiberry
			mv /mnt/dietpi_userdata/uae4arm-rpi /mnt/dietpi_userdata/amiberry
			systemctl disable uae4arm-rpi.service
			rm /etc/systemd/system/uae4arm-rpi.service
			systemctl daemon-reload

			userdel -f amiberry

		fi
		#-------------------------------------------------------------------------------
		#Reinstalls (RPI)
		#	FFmpeg RPi (OpenMAX HW enc): https://github.com/Fourdee/DietPi/issues/869
		#	AmiBerry (Name change): https://github.com/Fourdee/DietPi/issues/850
		if (( $HW_MODEL < 10 )); then

			/DietPi/dietpi/dietpi-software reinstall 7 108

		fi
		#	(ALL)
		#	NAA Daemon: 3.5.1-35
		/DietPi/dietpi/dietpi-software reinstall 124
		#-------------------------------------------------------------------------------
		#Regen Swapfile in auto mode, if unchanged from 100MB (previously default)
		SWAP_SIZE=$(cat /DietPi/dietpi.txt | grep -m1 '^Swapfile_Size=' | sed 's/.*=//' )
		if (( $SWAP_SIZE == 100 )); then

			/DietPi/dietpi/func/dietpi-set_dphys-swapfile 1

		fi
		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 149 )); then
		#-------------------------------------------------------------------------------
		#Remove ARMbian-config left on Neo image:
		rm /etc/profile.d/check_first_login_reboot.sh &> /dev/null
		#-------------------------------------------------------------------------------
		#XU4 kernel 4.9 prep: https://github.com/Fourdee/DietPi/issues/899
		if (( $HW_MODEL == 11 && $(uname -r | grep -ci -m1 '^3.' ) )); then

			# - Replace /dev/mmcblk0p* in /etc/fstab + boot.ini with UUID as required by 4.9 kernel+uboot
			#	MMC0p1
			UUID_CURRENT=$(blkid /dev/mmcblk0p1 -s UUID -o value)
			sed -i "s#^/dev/mmcblk0p1#UUID=$UUID_CURRENT#g" /etc/fstab

			#	MMC0p2
			UUID_CURRENT=$(blkid /dev/mmcblk0p2 -s UUID -o value)
			sed -i "s#^/dev/mmcblk0p2#UUID=$UUID_CURRENT#g" /etc/fstab
			systemctl daemon-reload

			sed -i "s#root=/dev/mmcblk0p2#root=UUID=$UUID_CURRENT#g" /DietPi/boot.ini

			# - XU3/4 DTBs are now unique, but, we have no known way of knowing if XU3 or XU4 is current board via system cmds:
			#	Copy xu3 dtb to xu4 dtb so we can prep for this now when 4.9 arrives
			cp /boot/exynos5422-odroidxu3.dtb /boot/exynos5422-odroidxu4.dtb

			#	Assume XU4
			if (( ! $USER_INPUTS )); then

				sed -i "s#exynos5422-odroidxu3.dtb#exynos5422-odroidxu4.dtb#g" /DietPi/boot.ini

			#	Request
			else

				whiptail --title "XU4 4.9 Prep" --yesno "In preperation for the XU4 4.9 kernel, DTB's will be unique for XU3/4 boards.\n\nIs this board an Odroid XU4 (eg: NOT XU3)?" --backtitle "DietPi-Update" 12 70
				if (( $? == 0 )); then

					sed -i "s#exynos5422-odroidxu3.dtb#exynos5422-odroidxu4.dtb#g" /DietPi/boot.ini

				fi

			fi

		fi
		#-------------------------------------------------------------------------------
		#Minor tweaks to cron.hourly
		cp /DietPi/dietpi/conf/cron.hourly_dietpi /etc/cron.hourly/dietpi
		chmod +x /etc/cron.hourly/dietpi
		#-------------------------------------------------------------------------------
		#DietPi-Drive_Manager RO under '/':
		cat << _EOF_ > /etc/systemd/system/dietpi-ramdisk.service
[Unit]
Description=DietPi-RAMdisk
After=local-fs.target

[Service]
Type=forking
RemainAfterExit=yes
ExecStartPre=/bin/mkdir -p /etc/dietpi/logs
ExecStart=/bin/bash -c '/boot/dietpi/dietpi-ramdisk 0'
ExecStop=/bin/bash -c '/DietPi/dietpi/dietpi-ramdisk 1'

[Install]
WantedBy=local-fs.target
_EOF_
		systemctl enable dietpi-ramdisk.service
		systemctl daemon-reload
		#-------------------------------------------------------------------------------
		#NanoPi M3 update DietPi kernel: https://github.com/Fourdee/DietPi/issues/763 + https://github.com/Fourdee/DietPi/issues/920
		if (( $HW_MODEL == 62 )); then

			/DietPi/dietpi/func/dietpi-set_hardware kernel nanopim3

		fi
		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 150 )); then
		#-------------------------------------------------------------------------------
		#Fix for VM fstab: https://github.com/Fourdee/DietPi/issues/960
		#	Removal of quotations in UUID entry
		if (( $HW_MODEL == 20 )); then

			sed -i 's#"044766be-96ca-491a-a93f-913b75a843bd"#044766be-96ca-491a-a93f-913b75a843bd#g' /etc/fstab
			systemctl daemon-reload

		fi
		#-------------------------------------------------------------------------------
		#Reinstalls
		#	Shairport-sync: https://github.com/Fourdee/DietPi/issues/962
		/DietPi/dietpi/dietpi-software reinstall 37
		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 151 )); then
		#-------------------------------------------------------------------------------
		#Reinstalls
		#	WiringPi: https://github.com/Fourdee/DietPi/issues/1001
		/DietPi/dietpi/dietpi-software reinstall 70
		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 152 )); then
		#-------------------------------------------------------------------------------
		#Disable /tmp tmpfs if RAM <= 512MB: https://github.com/Fourdee/DietPi/issues/1027
		if (( $(free -m | grep -m1 'Mem:' | awk '{print $2}') <= 512 )); then

			sed -i -e "\@[[:space:]]/tmp[[:space:]]@s@^#*@#@" /etc/fstab
			systemctl daemon-reload
			mount -a

		fi
		#-------------------------------------------------------------------------------
		#Disable SystemD daily apt processing: https://github.com/Fourdee/DietPi/issues/1032#issuecomment-311942730
		systemctl mask apt-daily.service &> /dev/null
		systemctl mask apt-daily-upgrade.timer &> /dev/null
		#-------------------------------------------------------------------------------
		#Odroid C2 Stretch, missing gnupg, install on all systems by default: https://github.com/Fourdee/DietPi/issues/1032
		apt-get install gnupg -y
		#-------------------------------------------------------------------------------
		#Firmware for Native PC: https://github.com/Fourdee/DietPi/issues/1007#issuecomment-312442384
		if (( $HW_MODEL == 21 )); then

			apt-get install firmware-linux-nonfree -y
			cp /boot/dietpi/conf/htoprc /root/.config/htop/htoprc # Also missing our htop cfg

		fi
		#-------------------------------------------------------------------------------
		#Sparky kernel update:
		#	v151 | Updated kernel.dtb for USB Bridge support
		#	v153 | Updated driver for Piano DAC + (dual output modes)
		if (( $HW_MODEL == 70 )); then

			wget https://raw.githubusercontent.com/sparky-sbc/sparky-test/master/usb-port1-enable/kernel.dtb -O /boot/kernel.dtb
			wget https://raw.githubusercontent.com/sparky-sbc/sparky-test/master/piano-dac-plus-mono/snd-soc-allo-piano-dac-plus.ko -O /lib/modules/$(uname -r)/kernel/sound/soc/atc260x/snd-soc-allo-piano-dac-plus.ko

		fi
		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 153 )); then
		#-------------------------------------------------------------------------------
		#NTPD mirror: https://github.com/Fourdee/DietPi/issues/1049
		if (( ! $(cat /DietPi/dietpi.txt | grep -ci -m1 '^NTPD_Mirror=') )); then

			cat << _EOF_ >> /DietPi/dietpi.txt
#NTPD mirror, applied to /etc/ntp.conf
#	For a full list, please see http://www.pool.ntp.org
#	Please remove the initial interger and full stop from the value (removing 0.). eg: debian.pool.ntp.org
NTPD_Mirror=debian.pool.ntp.org
_EOF_

		fi
		#-------------------------------------------------------------------------------
		# + RPi SDTV modes: https://github.com/Fourdee/DietPi/issues/1058
		if (( ! $(cat /DietPi/config.txt | grep -ci -m1 'sdtv_mode=') )); then

			cat << _EOF_ >> /DietPi/config.txt
#sdtv_mode=0
_EOF_

		fi
		#-------------------------------------------------------------------------------
		# Purge unnecessary pciutils package: https://github.com/Fourdee/DietPi/issues/1068
		apt purge -y pciutils
		#-------------------------------------------------------------------------------
		# RPi Stretch: Switch to new stretch repo on archive.raspberrypi.org: https://github.com/Fourdee/DietPi/issues/1077
		if (( $HW_MODEL < 10 && $DISTRO == 4 )); then # RPi + Stretch
			echo "deb https://archive.raspberrypi.org/debian/ stretch main ui" > /etc/apt/sources.list.d/raspi.list
			apt update
			AGU
			AGDU
		fi
		#-------------------------------------------------------------------------------
		#Native PC, add i386 support by default
		if (( $HW_MODEL == 21 )); then

			dpkg --add-architecture i386
			apt-get update

		fi
		#-------------------------------------------------------------------------------
		#Open Bazaar SystemD service:
		if [ -f /DietPi/dietpi/.installed ] &&
			(( $(cat /DietPi/dietpi/.installed | grep -ci -m1 '^aSOFTWARE_INSTALL_STATE\[58\]=2') )); then

			cat << _EOF_ > /etc/systemd/system/openbazaar.service
[Unit]
Description=openbazaar

[Service]
Type=simple
WorkingDirectory=/etc/openbazaar-server
ExecStart=$(which python) openbazaard.py start -a 0.0.0.0

[Install]
WantedBy=multi-user.target
_EOF_
			systemctl daemon-reload
			/DietPi/dietpi/dietpi-services disable

		fi
		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 154 )); then
		#-------------------------------------------------------------------------------
		#Deb multimedia repo remove for ALL installs: https://github.com/Fourdee/DietPi/issues/1096#issuecomment-318076721
		rm /etc/apt/sources.list.d/deb-multimedia.list &> /dev/null
		#-------------------------------------------------------------------------------
		#FS forced resize option (dev use)
		if (( ! $(cat /DietPi/dietpi.txt | grep -ci -m1 '^fs_force_resize=') )); then

			cat << _EOF_ >> /DietPi/dietpi.txt
#Forces a partition resize + expansion of rootfs on next boot. (0=disabled, 1=enabled)
fs_force_resize=0
_EOF_

		fi
		#-------------------------------------------------------------------------------
		#Fix error log on disabled IPv6: https://github.com/Fourdee/DietPi/issues/1119
		sed -i '/net.ipv6.conf.all.disable_ipv6 /c\' /etc/sysctl.conf
		sed -i '/net.ipv6.conf.default.disable_ipv6 /c\' /etc/sysctl.conf
		sed -i '/net.ipv6.conf.lo.disable_ipv6 /c\' /etc/sysctl.conf
		#-------------------------------------------------------------------------------
		#Prefer to use wlan/eth naming for networked devices (eg: stretch)
		ln -s /dev/null /etc/systemd/network/99-default.link
		#-------------------------------------------------------------------------------
		#Force auto size/gen of swapfile: https://github.com/Fourdee/DietPi/issues/1126#issuecomment-326749203
		/DietPi/dietpi/func/dietpi-set_dphys-swapfile 1
		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 155 )); then
		#-------------------------------------------------------------------------------
		#Sparky kernel update to resolve slow playback under 16bit: https://community.roonlabs.com/t/allo-usbridge-board/27487/148
		if (( $HW_MODEL == 70 )); then

			/DietPi/dietpi/func/dietpi-set_hardware kernel sparky_sbc

			# - Update disabled modules
			cat << _EOF_ > /etc/modprobe.d/disable_sparkysbc_touchscreen.conf
blacklist owl_camera
blacklist gsensor_stk8313
blacklist ctp_ft5x06
blacklist ctp_gsl3680
blacklist gsensor_bma222
blacklist gsensor_mir3da
_EOF_

			cat << _EOF_ > /etc/modprobe.d/disable_sparkysbc_gpu.conf
blacklist pvrsrvkm
blacklist drm
blacklist videobuf2_vmalloc
blacklist bc_example
_EOF_

		fi
		#-------------------------------------------------------------------------------
		#dietpi.txt entry for cpu_min_freq: https://github.com/Fourdee/DietPi/pull/1148
		if (( ! $(cat /DietPi/dietpi.txt | grep -ci -m1 '^cpu_min_frequency=') )); then

			cat << _EOF_ >> /DietPi/dietpi.txt
cpu_min_frequency=Disabled
_EOF_
		fi
		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 156 )); then
		#-------------------------------------------------------------------------------
		#Set Ondemand as default CPU gov: https://github.com/Fourdee/DietPi/issues/1141
		sed -i "/cpu_governor=/c\cpu_governor=ondemand" /DietPi/dietpi.txt
		#-------------------------------------------------------------------------------
		#Reinstalls Allo Web interface Only
		if (( $(cat /DietPi/dietpi/.installed | grep -ci -m1 '^aSOFTWARE_INSTALL_STATE\[159\]=2') )); then

			#Update V2 images
			if [ -f /etc/dietpi/.allo_web_image_version ] && (( $(cat /etc/dietpi/.allo_web_image_version) == 2 )); then

				#Update period size change for Squeezelite:
				cp /DietPi/dietpi/conf/squeezelite.service /etc/systemd/system/squeezelite.service
				systemctl daemon-reload

			#Update V1 images
			else

				# - Add quick reinstall entry if does not exist
				if (( ! $(cat /DietPi/dietpi/.installed | grep -ci -m1 '^aSOFTWARE_INSTALL_STATE\[160\]=2') )); then

					echo -e "aSOFTWARE_INSTALL_STATE[160]=2" >> /DietPi/dietpi/.installed

				fi

				# - Quick update
				#/DietPi/dietpi/dietpi-software reinstall 160

				# - Full update (including pre-req reinstalls)
				/DietPi/dietpi/dietpi-software reinstall 159

			fi

		#Reinstalls Everything else
		else

			#	Squeezelite/Shairport-sync
			/DietPi/dietpi/dietpi-software reinstall 36 37

		fi
		#-------------------------------------------------------------------------------
		#RPi update DietPi kernel:
		if (( $HW_MODEL < 10 )); then

			# - remove old flags
			rm /etc/dietpi/.dietpi_rpi &> /dev/null
			rm /etc/dietpi/.384khz_rpi &> /dev/null

			/DietPi/dietpi/func/dietpi-set_hardware kernel dietpi_rpi

			# Sabre module update
			if (( $(cat /DietPi/config.txt | grep -ci -m1 'dtoverlay=i-sabre-k2m') )); then

				whiptail --title "i-sabre-k2m" --msgbox "Due to a kernel update, this driver must be reinstalled, however, this can only be completed after the system is rebooted.\n\nOnce the system reboots:\n - use DietPi-Config to select soundcard 'none'\n - then reselect 'i-sabre-k2m'\n - Reboot system" 14 70

			fi

		fi
		#-------------------------------------------------------------------------------

	fi

		#-------------------------------------------------------------------------------
		#NB: If running apt-get upgrade, use non-interactive function instead: https://github.com/Fourdee/DietPi/issues/689
		#	AGU  = apt-get upgrade
		#	AGDU = apt-get dist-upgrade
		#NB: all if statements must contain at least one command. Prevents bash having a hissy fit :)
		#-------------------------------------------------------------------------------

	#-------------------------------------------------------------------------------
	sleep 0.25
	#-------------------------------------------------------------------------------
	exit
	#-------------------------------------------------------------------------------
}
